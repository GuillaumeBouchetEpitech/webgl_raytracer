(()=>{var We=Object.defineProperty,Et=Object.defineProperties;var wt=Object.getOwnPropertyDescriptors;var He=Object.getOwnPropertySymbols;var Dt=Object.prototype.hasOwnProperty,Vt=Object.prototype.propertyIsEnumerable;var Ge=(e,t,r)=>t in e?We(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,ee=(e,t)=>{for(var r in t||(t={}))Dt.call(t,r)&&Ge(e,r,t[r]);if(He)for(var r of He(t))Vt.call(t,r)&&Ge(e,r,t[r]);return e},ve=(e,t)=>Et(e,wt(t));var q=(e,t)=>{for(var r in t)We(e,r,{get:t[r],enumerable:!0})};var Ye=["requestFullscreen","webkitRequestFullscreen","mozRequestFullScreen","msRequestFullscreen"],Ct=["fullscreenchange","webkitfullscreenchange","mozfullscreenchange","msfullscreenchange"],Ce=class{constructor(){this._onFullScreenChangeCallbacks=[];this._isInitialized=!1}_initialize(){if(this._isInitialized)return;this._isInitialized=!0;let t=()=>{this._onFullScreenChangeCallbacks.forEach(r=>r())};for(let r of Ct)document.addEventListener(r,t,!1)}isCompatible(t){for(let r of Ye)if(r in t)return!0;return!1}isFullScreen(t){return document.fullscreenElement===t}async requestFullScreen(t){if(this.isFullScreen(t))return{success:!1,message:"element already in full screen"};this._initialize();for(let r of Ye)if(r in t)return t[r](),{success:!0,message:"request for full screen done"};return{success:!1,message:"unsupported request for full screen"}}addOnFullScreenChange(t){this._onFullScreenChangeCallbacks.push(t)}removeOnFullScreenChange(t){let r=this._onFullScreenChangeCallbacks.indexOf(t);r<0||this._onFullScreenChangeCallbacks.splice(r,1)}},li=new Ce;var ge={Num0:48,Num1:49,Num2:50,Num3:51,Num4:52,Num5:53,Num6:54,Num7:55,Num8:56,Num9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,Semicolon:186,Equal:187,Comma:188,Minus:189,Period:190,BackQuote:192,BracketLeft:219,Backslash:220,BracketRight:221,Quote:222,Shift:16,Ctrl:17,Alt:18,CapsLock:20,Tab:9,Enter:13,Pause:19,Escape:27,Space:32,PageUp:33,PageDown:34,End:35,Home:36,ArrowLeft:37,ArrowUp:38,ArrowRight:39,ArrowDown:40,PrintScreen:44,Insert:45,Delete:46,ContextMenu:93,ScrollLock:145,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,F13:124,F14:125,F15:126,F16:127,F17:128,F18:129,F19:130,F20:131,F21:132,F22:133,F23:134,F24:135,NumPad0:96,NumPad1:97,NumPad2:98,NumPad3:99,NumPad4:100,NumPad5:101,NumPad6:102,NumPad7:103,NumPad8:104,NumPad9:105,NumPadMultiply:106,NumPadAdd:107,NumPadSubtract:109,NumPadDecimal:110,NumPadDivide:111,NumLock:144,NumPadComma:194,NumPadEqual:12};var Le=class{constructor(){this._pressedKeysSet=new Set;this._preventDefaultKeysSet=new Set;this._activated=!1;let t=a=>{let{keyCode:i}=a;this._preventDefaultKeysSet.has(i)&&a.preventDefault(),this._pressedKeysSet.add(i)},r=a=>{let{keyCode:i}=a;this._preventDefaultKeysSet.has(i)&&a.preventDefault(),this._pressedKeysSet.delete(i)};this._activated=!1,this._handleKeyDown=t.bind(this),this._handleKeyUp=r.bind(this)}isPressed(...t){for(let r of t)if(this._pressedKeysSet.has(ge[r]))return!0;return!1}preventDefault(t){this._preventDefaultKeysSet.add(ge[t])}enableDefault(t){this._preventDefaultKeysSet.delete(ge[t])}activate(){this._activated||(this._pressedKeysSet.clear(),document.addEventListener("keydown",this._handleKeyDown),document.addEventListener("keyup",this._handleKeyUp),this._activated=!0)}deactivate(){this._activated&&(this._pressedKeysSet.clear(),document.removeEventListener("keydown",this._handleKeyDown),document.removeEventListener("keyup",this._handleKeyUp),this._activated=!1)}},z=new Le;var Lt={Left:0,Middle:1,Right:2},Ae=class{constructor(){this._pressedButtonsSet=new Set;this._activated=!1;this._deltaX=0;this._deltaY=0;let t=i=>{this._pressedButtonsSet.add(i.button)},r=i=>{this._pressedButtonsSet.delete(i.button)},a=i=>{this._deltaX+=i.movementX||i.mozMovementX||i.webkitMovementX||0,this._deltaY+=i.movementY||i.mozMovementY||i.webkitMovementY||0};this._activated=!1,this._handleMouseDown=t.bind(this),this._handleMouseUp=r.bind(this),this._handleMouseMove=a.bind(this)}activate(){this._activated||(this._pressedButtonsSet.clear(),document.addEventListener("mousedown",this._handleMouseDown),document.addEventListener("mouseup",this._handleMouseUp),document.addEventListener("mousemove",this._handleMouseMove),this._activated=!0)}deactivate(){this._activated&&(this._pressedButtonsSet.clear(),document.removeEventListener("mousedown",this._handleMouseDown),document.removeEventListener("mouseup",this._handleMouseUp),document.removeEventListener("mousemove",this._handleMouseMove),this._activated=!1)}isButtonPressed(t){return this._pressedButtonsSet.has(Lt[t])}deltaX(){return this._deltaX}deltaY(){return this._deltaY}resetDelta(){this._deltaX=0,this._deltaY=0}},Q=new Ae;var Xe=["requestPointerLock","mozRequestPointerLock","webkitRequestPointerLock"],At=["exitPointerLock","mozExitPointerLock","webkitExitPointerLock"],zt=["pointerLockElement","mozPointerLockElement","webkitPointerLockElement"],kt=[{methodName:"onpointerlockchange",propertyName:"pointerlockchange"},{methodName:"onmozpointerlockchange",propertyName:"mozpointerlockchange"},{methodName:"onwebkitpointerlockchange",propertyName:"webkitpointerlockchange"}],It=[{methodName:"onpointerlockerror",propertyName:"pointerlockerror"},{methodName:"onmozpointerlockerror",propertyName:"mozpointerlockerror"},{methodName:"onwebkitpointerlockerror",propertyName:"webkitpointerlockerror"}],ze=class{constructor(){this._onLockChangeCallbacks=[];this._onLockErrorCallbacks=[];this._timeSinceLastLockChange=0;this._isInitialized=!1}_initialize(){if(this._isInitialized)return;this._isInitialized=!0;let t=()=>{this._timeSinceLastLockChange=Date.now(),this._onLockChangeCallbacks.forEach(a=>a())},r=a=>{this._timeSinceLastLockChange=Date.now(),this._onLockErrorCallbacks.forEach(i=>i(a))};for(let a of kt)if(a.methodName in document){document.addEventListener(a.propertyName,t,!1);break}for(let a of It)if(a.methodName in document){document.addEventListener(a.propertyName,r,!1);break}}canBePointerLocked(t){for(let r of Xe)if(r in t)return!0;return!1}isPointerLocked(t){for(let r of zt)if(r in document)return document[r]===t;return!1}async requestPointerLock(t){if(this.isPointerLocked(t))return{success:!1,message:"element already locked"};if(this._initialize(),this._timeSinceLastLockChange>0){let r=(Date.now()-this._timeSinceLastLockChange)/1e3;if(r<1.1)return{success:!1,message:"request for lock was too early, time to wait: ".concat(r.toFixed(2),"sec")}}this._timeSinceLastLockChange=Date.now();for(let r of Xe)if(r in t){let a={unadjustedMovement:!1};try{await t[r](a)}catch(i){let n=(Date.now()-this._timeSinceLastLockChange)/1e3;return{success:!1,message:"request for lock was too early, time to wait: ".concat(n.toFixed(2),"sec")}}return this._timeSinceLastLockChange=Date.now(),{success:!0,message:"request for lock done"}}return{success:!1,message:"unsupported request for lock"}}allowPointerLockedOnClickEvent(t){if(t===this._latestRequestHtmlElement)return;this._latestRequestHtmlElement=t;let r=async()=>{t.removeEventListener("click",r);let a=await this.requestPointerLock(t);this._latestRequestHtmlElement=void 0,a.success||this.allowPointerLockedOnClickEvent(t)};t.addEventListener("click",r)}exitPointerLock(){for(let t of At)if(t in document){document[t]();break}}addOnLockChange(t){this._onLockChangeCallbacks.push(t)}removeOnLockChange(t){let r=this._onLockChangeCallbacks.indexOf(t);r<0||this._onLockChangeCallbacks.splice(r,1)}addOnLockError(t){this._onLockErrorCallbacks.push(t)}removeOnLockError(t){let r=this._onLockErrorCallbacks.indexOf(t);r<0||this._onLockErrorCallbacks.splice(r,1)}},j=new ze;var ke=class{constructor(t,r,a){this.createdAt=Date.now();this.deltaX=0;this.deltaY=0;this.id=t,this.positionX=r,this.positionY=a}resetDelta(){this.deltaX=0,this.deltaY=0}},Ie=class{constructor(){this._activated=!1;this._allTouchDataMap=new Map;this._allCachedTouchDataArray=[];let t=i=>{i.preventDefault();for(let n=0;n<i.changedTouches.length;++n){let{identifier:o,pageX:s,pageY:f}=i.changedTouches[n],l=new ke(o,s,f);this._allTouchDataMap.set("".concat(o),l),this._allCachedTouchDataArray.length=0}},r=i=>{i.preventDefault();for(let n=0;n<i.changedTouches.length;++n){let{identifier:o}=i.changedTouches[n];this._allTouchDataMap.delete("".concat(o)),this._allCachedTouchDataArray.length=0}},a=i=>{i.preventDefault();for(let n=0;n<i.changedTouches.length;++n){let{identifier:o,pageX:s,pageY:f}=i.changedTouches[n],l=this._allTouchDataMap.get("".concat(o));if(!l)continue;let d=s-l.positionX,h=f-l.positionY;l.deltaX+=d,l.deltaY+=h,l.positionX=s,l.positionY=f}};this._activated=!1,this._handleTouchStart=t.bind(this),this._handleTouchEnd=r.bind(this),this._handleTouchMove=a.bind(this)}isSupported(t){return"ontouchstart"in t}activate(t){this.isSupported(t)&&(this._activated||(this._allTouchDataMap.clear(),this._allCachedTouchDataArray.length=0,t.addEventListener("touchstart",this._handleTouchStart),t.addEventListener("touchend",this._handleTouchEnd),t.addEventListener("touchcancel",this._handleTouchEnd),t.addEventListener("touchmove",this._handleTouchMove,{passive:!1}),this._activated=!0))}deactivate(t){this._activated&&(this._allTouchDataMap.clear(),this._allCachedTouchDataArray.length=0,t.removeEventListener("touchstart",this._handleTouchStart),t.removeEventListener("touchend",this._handleTouchEnd),t.removeEventListener("touchcancel",this._handleTouchEnd),t.removeEventListener("touchmove",this._handleTouchMove),this._activated=!1)}_refreshCache(){this._allCachedTouchDataArray.length===0&&(this._allCachedTouchDataArray=[...this._allTouchDataMap.values()])}getTouchData(){return this._refreshCache(),this._allCachedTouchDataArray}resetDeltas(){this._refreshCache(),this._allCachedTouchDataArray.forEach(t=>t.resetDelta())}},J=new Ie;var qe=()=>!!window.WebGL2RenderingContext;var Pe={};q(Pe,{DataTexture:()=>te,FrameBuffer:()=>re,GeometryWrapper:()=>P,ShaderProgram:()=>O,Texture:()=>W,WebGLContext:()=>T});var N=class N{static initialize(t){let r={alpha:!1,antialias:!1,depth:!0,failIfMajorPerformanceCaveat:!1,powerPreference:"high-performance",premultipliedAlpha:!0,preserveDrawingBuffer:!0,stencil:!1};if(N._gl=t.getContext("webgl2",r),!N._gl)throw new Error("could not create webgl context");N._extensionLoseContext=N._gl.getExtension("WEBGL_lose_context"),N._gl.getExtension("EXT_color_buffer_float"),N._gl.getExtension("EXT_float_blend")}static getContext(){if(!N._gl)throw new Error("webgl context not initialized");return N._gl}static getExtensionLoseContext(){return N._extensionLoseContext}static getExtensionLoseContextStrict(){if(!N._extensionLoseContext)throw new Error("lose context extension not available");return N._extensionLoseContext}};N._gl=null,N._extensionLoseContext=null;var T=N;var te=class{constructor(){this._texture=null}initialize(t=[]){if(this._texture)throw new Error("data texture already initialized");let r=T.getContext();this._texture=r.createTexture(),r.bindTexture(r.TEXTURE_2D,this._texture),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),this.update(t)}update(t){if(!this._texture)throw new Error("data texture not initialized");let r=T.getContext();r.bindTexture(r.TEXTURE_2D,this._texture);let a=new Float32Array(t),i=0,n=r.R32F,o=t.length,s=1,f=0,l=r.RED,d=r.FLOAT;r.texImage2D(r.TEXTURE_2D,i,n,o,s,f,l,d,a)}bind(){if(!this._texture)throw new Error("data texture not initialized");let t=T.getContext();t.bindTexture(t.TEXTURE_2D,this._texture)}};var re=class{constructor(){let t=T.getContext();this._frameBuffer=t.createFramebuffer()}attachTexture(t){let r=T.getContext();r.bindFramebuffer(r.FRAMEBUFFER,this._frameBuffer);let a=0;r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,t.getRawObject(),a)}bind(){let t=T.getContext();t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer)}static unbind(){let t=T.getContext();t.bindFramebuffer(t.FRAMEBUFFER,null)}};var P;(o=>{o.BytesPerPixel=4;let t;(u=>(u[u.float=0]="float",u[u.vec2f=1]="vec2f",u[u.vec3f=2]="vec3f",u[u.vec4f=3]="vec4f",u[u.mat3f=4]="mat3f",u[u.mat4f=5]="mat4f"))(t=o.AttributeType||(o.AttributeType={}));let r=s=>{switch(s){case 0:return 1;case 1:return 2;case 2:return 3;case 3:return 4;case 4:return 9;case 5:return 16}},a;(d=>(d[d.lines=0]="lines",d[d.triangles=1]="triangles",d[d.triangleStrip=2]="triangleStrip"))(a=o.PrimitiveType||(o.PrimitiveType={}));class i{constructor(f,l){this._primitiveStart=0;this._primitiveCount=0;this._instanceCount=0;this._isInstanced=!1;let d=T.getContext();if(l.vbos.length===0)throw new Error("empty vbo definition");for(let m of l.vbos){if(m.attrs.length===0)throw new Error("empty vbo attribute definition");for(let u of m.attrs)if(!f.hasAttribute(u.name))throw new Error('attribute not found, name="'.concat(u.name,'"'))}switch(this._def=l,l.primitiveType){case 0:this._primitiveType=d.LINES;break;case 1:this._primitiveType=d.TRIANGLES;break;case 2:this._primitiveType=d.TRIANGLE_STRIP;break;default:throw new Error("primitive type not found")}let h=d.createVertexArray();if(!h)throw new Error("fail o create a vao unit");this._vao=h,d.bindVertexArray(this._vao),this._vbos=[];for(let m of this._def.vbos){let u=d.createBuffer();if(!u)throw new Error("fail o create a vbo unit");this._vbos.push({object:u,maxSize:0,dynamic:m.dynamic||!1}),d.bindBuffer(d.ARRAY_BUFFER,u);let v=m.stride||0;if(!v){for(let _ of m.attrs)switch(_.type){case 0:v+=1;break;case 1:v+=2;break;case 2:v+=3;break;case 3:v+=4;break;case 4:v+=9;break;case 5:v+=16;break}v*=4}for(let _ of m.attrs){let p=1,x=1;switch(_.type){case 0:p=1,x=1;break;case 1:p=2,x=1;break;case 2:p=3,x=1;break;case 3:p=4,x=1;break;case 4:p=3,x=3;break;case 5:p=4,x=4;break}let M=f.getAttribute(_.name);for(let y=0;y<x;++y){let b=M+y,R=(_.index+y*p)*4;d.enableVertexAttribArray(b),d.vertexAttribPointer(b,p,d.FLOAT,!1,v,R),m.instanced===!0&&(d.vertexAttribDivisor(b,1),this._isInstanced=!0)}}}d.bindVertexArray(null)}dispose(){let f=T.getContext();for(let l of this._vbos)f.deleteBuffer(l.object);this._vbos.length=0,f.deleteVertexArray(this._vao)}setBufferSize(f,l){if(f<0||f>=this._vbos.length)throw new Error("no buffer available to that index");if(l<=0)return;let d=this._vbos[f];if(l<d.maxSize)return;d.maxSize=l;let h=T.getContext(),m=d.dynamic?h.DYNAMIC_DRAW:h.STATIC_DRAW;h.bindBuffer(h.ARRAY_BUFFER,d.object),h.bufferData(h.ARRAY_BUFFER,l,m),h.bindBuffer(h.ARRAY_BUFFER,null)}setFloatBufferSize(f,l){this.setBufferSize(f,l*4)}updateBuffer(f,l,d){if(f<0||f>=this._vbos.length)throw new Error("no buffer available to that index");if(d<=0)return;let h=T.getContext(),m=l instanceof Float32Array?l:new Float32Array(l),u=this._vbos[f];if(h.bindBuffer(h.ARRAY_BUFFER,u.object),d>u.maxSize){u.maxSize=d;let v=u.dynamic?h.DYNAMIC_DRAW:h.STATIC_DRAW;h.bufferData(h.ARRAY_BUFFER,m,v,0,d)}else h.bufferSubData(h.ARRAY_BUFFER,0,m,0,d);h.bindBuffer(h.ARRAY_BUFFER,null)}render(){if(this._primitiveCount==0||this._isInstanced&&this._instanceCount==0)return;let f=T.getContext();f.bindVertexArray(this._vao),this._isInstanced===!0?f.drawArraysInstanced(this._primitiveType,this._primitiveStart,this._primitiveCount,this._instanceCount):f.drawArrays(this._primitiveType,this._primitiveStart,this._primitiveCount),f.bindVertexArray(null)}setPrimitiveStart(f){this._primitiveStart=f}setPrimitiveCount(f){this._primitiveCount=f}setInstancedCount(f){this._instanceCount=f}}o.Geometry=i;class n{constructor(){this._def={vbos:[],primitiveType:0}}reset(){return this._def={vbos:[],primitiveType:0},this}getDef(){return this._def}setPrimitiveType(f){return this._def.primitiveType=a[f],this}addVbo(){return this._def.vbos.push({attrs:[],instanced:!1}),this}setVboAsInstanced(){return this._getLastVbo().instanced=!0,this}setVboAsDynamic(){return this._getLastVbo().dynamic=!0,this}setStride(f){return this._getLastVbo().stride=f,this}addVboAttribute(f,l){let d=this._getLastVbo(),h=d.attrs.length>0?d.attrs[d.attrs.length-1]:null;return d.attrs.push({name:f,type:t[l],index:h?h.index+r(h.type):0}),this}_getLastVbo(){if(this._def.vbos.length===0)throw new Error("no VBO setup");return this._def.vbos[this._def.vbos.length-1]}}o.GeometryBuilder=n})(P||(P={}));var G=class G{constructor(t,r){this._attributes=new Map;this._uniforms=new Map;this._name=t;let a=T.getContext(),i=this._getShader(r.vertexSrc,a.VERTEX_SHADER),n=this._getShader(r.fragmentSrc,a.FRAGMENT_SHADER),o=a.createProgram();if(!o)throw new Error("could not create a shader program");if(a.attachShader(o,i),a.attachShader(o,n),a.linkProgram(o),a.deleteShader(i),a.deleteShader(n),!a.getProgramParameter(o,a.LINK_STATUS)){let s=a.getProgramInfoLog(o);throw new Error("Failed to initialized shaders, Error linking:"+s)}this._program=o,this.bind(()=>{this._getAttributes(r.attributes),this._getUniforms(r.uniforms)})}async bind(t){if(G._isBound!==null)throw new Error("Double shader binding (bound: ".concat(G._isBound._name,", binding: ").concat(this._name,")"));G._isBound=this,T.getContext().useProgram(this._program),t(),G.unbind()}static unbind(){T.getContext().useProgram(null),G._isBound=null}isBound(){return G._isBound===this}hasAttribute(t){return this._attributes.has(t)}getAttribute(t){let r=this._attributes.get(t);if(r===void 0)throw new Error("attribute not found: ".concat(t));return r}getUniform(t){let r=this._uniforms.get(t);if(r===void 0)throw new Error("uniform not found: ".concat(t));return r}setTextureUniform(t,r,a){let i=T.getContext();i.activeTexture(i.TEXTURE0+a),i.uniform1i(this.getUniform(t),a),r.bind()}setInteger1Uniform(t,r){T.getContext().uniform1i(this.getUniform(t),r)}setInteger2Uniform(t,r,a){T.getContext().uniform2i(this.getUniform(t),r,a)}setInteger3Uniform(t,r,a,i){T.getContext().uniform3i(this.getUniform(t),r,a,i)}setFloat1Uniform(t,r){T.getContext().uniform1f(this.getUniform(t),r)}setFloat2Uniform(t,r,a){T.getContext().uniform2f(this.getUniform(t),r,a)}setFloat3Uniform(t,r,a,i){T.getContext().uniform3f(this.getUniform(t),r,a,i)}setMatrix4Uniform(t,r){T.getContext().uniformMatrix4fv(this.getUniform(t),!1,r)}_getAttributes(t){let r=T.getContext();for(let a=0;a<t.length;++a){let i=r.getAttribLocation(this._program,t[a]);if(i<0)throw new Error("attribute not found => ".concat(t[a]));this._attributes.set(t[a],i)}}_getUniforms(t){let r=T.getContext();for(let a=0;a<t.length;++a){let i=r.getUniformLocation(this._program,t[a]);if(i===null)throw new Error("uniform not found => ".concat(t[a]));this._uniforms.set(t[a],i)}}_getShader(t,r){let a=T.getContext(),i=a.createShader(r);if(!i)throw new Error("could not create a shader");if(a.shaderSource(i,t),a.compileShader(i),!a.getShaderParameter(i,a.COMPILE_STATUS)){let n=a.getShaderInfoLog(i);throw n||(n="failed to compile a shader"),new Error(n)}return i}};G._isBound=null;var O=G;var W=class{constructor(){this._width=0;this._height=0;this._texture=null}loadFromMemory(t,r,a){this._allocate(t,r,a)}allocate(t,r){this._allocate(t,r)}resize(t,r){this._allocate(t,r)}_allocate(t,r,a=null){let i=T.getContext();this._texture||(this._texture=i.createTexture()),i.bindTexture(i.TEXTURE_2D,this._texture),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST);let n=0,o=i.RGBA,s=0,f=i.RGBA,l=i.UNSIGNED_BYTE;i.texImage2D(i.TEXTURE_2D,n,o,t,r,s,f,l,a),i.bindTexture(i.TEXTURE_2D,null)}getWidth(){if(!this._texture)throw new Error("texture not initialized");return this._width}getHeight(){if(!this._texture)throw new Error("texture not initialized");return this._height}bind(){if(!this._texture)throw new Error("texture not initialized");let t=T.getContext();t.bindTexture(t.TEXTURE_2D,this._texture)}static unbind(){let t=T.getContext();t.bindTexture(t.TEXTURE_2D,null)}getRawObject(){if(!this._texture)throw new Error("texture not initialized");return this._texture}};var _e=class{constructor(t){this._lines=[];this._maxLines=30;if(this._textAreaElement=document.getElementById(t),!this._textAreaElement)throw new Error("DOM elements not found, id=".concat(t));this._textAreaElement.value=""}log(...t){if(t.length===0)return;let r=Array.prototype.slice.call(t).join(" ");console.log(r),this._pushText(r)}error(...t){if(t.length===0)return;let r=Array.prototype.slice.call(t).join(" ");console.error(r),this._pushText("[ERR] - ".concat(r))}_pushText(t){this._lines.push(t),this._lines.length>this._maxLines&&this._lines.splice(0,this._lines.length-this._maxLines),this._textAreaElement.value="".concat(this._lines.join("\n"),"\n"),this._textAreaElement.scrollTop=this._textAreaElement.scrollHeight}peekLast(){if(this._lines.length>0)return this._lines[this._lines.length-1]}popLast(){this._lines.length>0&&this._lines.splice(this._lines.length-1,1)}};var xe=class{constructor(){this._framesDelta=[];this._averageDelta=0;this._minDelta=0;this._maxDelta=0}pushDelta(t){this._framesDelta.length>=100&&this._framesDelta.shift(),this._framesDelta.push(t),this._minDelta=999999999,this._maxDelta=-999999999,this._averageDelta=0;for(let r of this._framesDelta)this._minDelta=Math.min(this._minDelta,r),this._maxDelta=Math.max(this._maxDelta,r),this._averageDelta+=r;this._averageDelta/=this._framesDelta.length}get framesDelta(){return this._framesDelta}get averageDelta(){return this._averageDelta}get minDelta(){return this._minDelta}get maxDelta(){return this._maxDelta}};var je=(e,t,r,a,i,n=!1)=>{let s=Math.ceil(r.maxDelta/5)*5;{a.pushOriginBoundRectangle(e,t,[0,0,0,.5]);let f=[[e[0]+t[0]*0,e[1]+t[1]*0,0],[e[0]+t[0]*1,e[1]+t[1]*0,0],[e[0]+t[0]*1,e[1]+t[1]*1,0],[e[0]+t[0]*0,e[1]+t[1]*1,0]];a.pushLine(f[0],f[1],[1,1,1]),a.pushLine(f[1],f[2],[1,1,1]),a.pushLine(f[2],f[3],[1,1,1]),a.pushLine(f[3],f[0],[1,1,1])}for(let f=5;f<s;f+=5){let l=f/s,d=[e[0]+0,e[1]+t[1]*l,0],h=[e[0]+t[0],e[1]+t[1]*l,0];a.pushLine(d,h,[.5,.5,.5])}if(r.framesDelta.length>=2){let f=t[0]/r.framesDelta.length,l=r.framesDelta[0],d=0,h=t[1]*l/s;for(let m=1;m<r.framesDelta.length;++m){let u=r.framesDelta[m],v=m*f,_=t[1]*u/s,p=[e[0]+d,e[1]+h,0],x=[e[0]+v,e[1]+_,0];a.pushLine(p,x,[1,1,1]),l=u,d=v,h=_}}{let d=r.averageDelta,h=r.maxDelta,m=r.minDelta,u="~".concat(d.toFixed(0),"ms"),v="<".concat(h,"ms"),_=">".concat(m,"ms");if(n===!0){let p=x=>x<999?x.toFixed(0):"???";u+="\n~".concat(p(1e3/d),"fps"),v+="\n<".concat(p(1e3/h),"fps"),_+="\n>".concat(p(1e3/m),"fps")}i.setTextScale(14).setTextAlign("left","top").setTextColor(1,1,.75).pushText(u,[e[0]+7,e[1]-8]).setTextAlign("left","centered").setTextColor(1,.75,.75).pushText(v,[e[0]+t[0]+7,e[1]+t[1]-7*1]).setTextColor(.75,1,.75).pushText(_,[e[0]+t[0]+7,e[1]+7*1]).setTextColor(1,1,1)}};var w=1e-6,B=typeof Float32Array<"u"?Float32Array:Array,ce=Math.random;var ji=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});var k={};q(k,{add:()=>xr,adjoint:()=>Gt,clone:()=>Ft,copy:()=>Bt,create:()=>Pt,determinant:()=>Wt,equals:()=>Sr,exactEquals:()=>Rr,frob:()=>_r,fromQuat:()=>fr,fromQuat2:()=>ar,fromRotation:()=>Jt,fromRotationTranslation:()=>Ze,fromRotationTranslationScale:()=>sr,fromRotationTranslationScaleOrigin:()=>or,fromScaling:()=>Qt,fromTranslation:()=>Zt,fromValues:()=>Nt,fromXRotation:()=>er,fromYRotation:()=>tr,fromZRotation:()=>rr,frustum:()=>lr,getRotation:()=>nr,getScaling:()=>Qe,getTranslation:()=>ir,identity:()=>Ke,invert:()=>Ht,lookAt:()=>pr,mul:()=>Tr,multiply:()=>$e,multiplyScalar:()=>yr,multiplyScalarAndAdd:()=>br,ortho:()=>mr,orthoNO:()=>et,orthoZO:()=>ur,perspective:()=>dr,perspectiveFromFieldOfView:()=>hr,perspectiveNO:()=>Je,perspectiveZO:()=>cr,rotate:()=>qt,rotateX:()=>jt,rotateY:()=>Kt,rotateZ:()=>$t,scale:()=>Xt,set:()=>Ut,str:()=>gr,sub:()=>Mr,subtract:()=>tt,targetTo:()=>vr,translate:()=>Yt,transpose:()=>Ot});function Pt(){var e=new B(16);return B!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function Ft(e){var t=new B(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function Bt(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function Nt(e,t,r,a,i,n,o,s,f,l,d,h,m,u,v,_){var p=new B(16);return p[0]=e,p[1]=t,p[2]=r,p[3]=a,p[4]=i,p[5]=n,p[6]=o,p[7]=s,p[8]=f,p[9]=l,p[10]=d,p[11]=h,p[12]=m,p[13]=u,p[14]=v,p[15]=_,p}function Ut(e,t,r,a,i,n,o,s,f,l,d,h,m,u,v,_,p){return e[0]=t,e[1]=r,e[2]=a,e[3]=i,e[4]=n,e[5]=o,e[6]=s,e[7]=f,e[8]=l,e[9]=d,e[10]=h,e[11]=m,e[12]=u,e[13]=v,e[14]=_,e[15]=p,e}function Ke(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Ot(e,t){if(e===t){var r=t[1],a=t[2],i=t[3],n=t[6],o=t[7],s=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=r,e[6]=t[9],e[7]=t[13],e[8]=a,e[9]=n,e[11]=t[14],e[12]=i,e[13]=o,e[14]=s}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e}function Ht(e,t){var r=t[0],a=t[1],i=t[2],n=t[3],o=t[4],s=t[5],f=t[6],l=t[7],d=t[8],h=t[9],m=t[10],u=t[11],v=t[12],_=t[13],p=t[14],x=t[15],M=r*s-a*o,y=r*f-i*o,b=r*l-n*o,R=a*f-i*s,S=a*l-n*s,D=i*l-n*f,V=d*_-h*v,L=d*p-m*v,C=d*x-u*v,A=h*p-m*_,I=h*x-u*_,F=m*x-u*p,E=M*F-y*I+b*A+R*C-S*L+D*V;return E?(E=1/E,e[0]=(s*F-f*I+l*A)*E,e[1]=(i*I-a*F-n*A)*E,e[2]=(_*D-p*S+x*R)*E,e[3]=(m*S-h*D-u*R)*E,e[4]=(f*C-o*F-l*L)*E,e[5]=(r*F-i*C+n*L)*E,e[6]=(p*b-v*D-x*y)*E,e[7]=(d*D-m*b+u*y)*E,e[8]=(o*I-s*C+l*V)*E,e[9]=(a*C-r*I-n*V)*E,e[10]=(v*S-_*b+x*M)*E,e[11]=(h*b-d*S-u*M)*E,e[12]=(s*L-o*A-f*V)*E,e[13]=(r*A-a*L+i*V)*E,e[14]=(_*y-v*R-p*M)*E,e[15]=(d*R-h*y+m*M)*E,e):null}function Gt(e,t){var r=t[0],a=t[1],i=t[2],n=t[3],o=t[4],s=t[5],f=t[6],l=t[7],d=t[8],h=t[9],m=t[10],u=t[11],v=t[12],_=t[13],p=t[14],x=t[15];return e[0]=s*(m*x-u*p)-h*(f*x-l*p)+_*(f*u-l*m),e[1]=-(a*(m*x-u*p)-h*(i*x-n*p)+_*(i*u-n*m)),e[2]=a*(f*x-l*p)-s*(i*x-n*p)+_*(i*l-n*f),e[3]=-(a*(f*u-l*m)-s*(i*u-n*m)+h*(i*l-n*f)),e[4]=-(o*(m*x-u*p)-d*(f*x-l*p)+v*(f*u-l*m)),e[5]=r*(m*x-u*p)-d*(i*x-n*p)+v*(i*u-n*m),e[6]=-(r*(f*x-l*p)-o*(i*x-n*p)+v*(i*l-n*f)),e[7]=r*(f*u-l*m)-o*(i*u-n*m)+d*(i*l-n*f),e[8]=o*(h*x-u*_)-d*(s*x-l*_)+v*(s*u-l*h),e[9]=-(r*(h*x-u*_)-d*(a*x-n*_)+v*(a*u-n*h)),e[10]=r*(s*x-l*_)-o*(a*x-n*_)+v*(a*l-n*s),e[11]=-(r*(s*u-l*h)-o*(a*u-n*h)+d*(a*l-n*s)),e[12]=-(o*(h*p-m*_)-d*(s*p-f*_)+v*(s*m-f*h)),e[13]=r*(h*p-m*_)-d*(a*p-i*_)+v*(a*m-i*h),e[14]=-(r*(s*p-f*_)-o*(a*p-i*_)+v*(a*f-i*s)),e[15]=r*(s*m-f*h)-o*(a*m-i*h)+d*(a*f-i*s),e}function Wt(e){var t=e[0],r=e[1],a=e[2],i=e[3],n=e[4],o=e[5],s=e[6],f=e[7],l=e[8],d=e[9],h=e[10],m=e[11],u=e[12],v=e[13],_=e[14],p=e[15],x=t*o-r*n,M=t*s-a*n,y=t*f-i*n,b=r*s-a*o,R=r*f-i*o,S=a*f-i*s,D=l*v-d*u,V=l*_-h*u,L=l*p-m*u,C=d*_-h*v,A=d*p-m*v,I=h*p-m*_;return x*I-M*A+y*C+b*L-R*V+S*D}function $e(e,t,r){var a=t[0],i=t[1],n=t[2],o=t[3],s=t[4],f=t[5],l=t[6],d=t[7],h=t[8],m=t[9],u=t[10],v=t[11],_=t[12],p=t[13],x=t[14],M=t[15],y=r[0],b=r[1],R=r[2],S=r[3];return e[0]=y*a+b*s+R*h+S*_,e[1]=y*i+b*f+R*m+S*p,e[2]=y*n+b*l+R*u+S*x,e[3]=y*o+b*d+R*v+S*M,y=r[4],b=r[5],R=r[6],S=r[7],e[4]=y*a+b*s+R*h+S*_,e[5]=y*i+b*f+R*m+S*p,e[6]=y*n+b*l+R*u+S*x,e[7]=y*o+b*d+R*v+S*M,y=r[8],b=r[9],R=r[10],S=r[11],e[8]=y*a+b*s+R*h+S*_,e[9]=y*i+b*f+R*m+S*p,e[10]=y*n+b*l+R*u+S*x,e[11]=y*o+b*d+R*v+S*M,y=r[12],b=r[13],R=r[14],S=r[15],e[12]=y*a+b*s+R*h+S*_,e[13]=y*i+b*f+R*m+S*p,e[14]=y*n+b*l+R*u+S*x,e[15]=y*o+b*d+R*v+S*M,e}function Yt(e,t,r){var a=r[0],i=r[1],n=r[2],o,s,f,l,d,h,m,u,v,_,p,x;return t===e?(e[12]=t[0]*a+t[4]*i+t[8]*n+t[12],e[13]=t[1]*a+t[5]*i+t[9]*n+t[13],e[14]=t[2]*a+t[6]*i+t[10]*n+t[14],e[15]=t[3]*a+t[7]*i+t[11]*n+t[15]):(o=t[0],s=t[1],f=t[2],l=t[3],d=t[4],h=t[5],m=t[6],u=t[7],v=t[8],_=t[9],p=t[10],x=t[11],e[0]=o,e[1]=s,e[2]=f,e[3]=l,e[4]=d,e[5]=h,e[6]=m,e[7]=u,e[8]=v,e[9]=_,e[10]=p,e[11]=x,e[12]=o*a+d*i+v*n+t[12],e[13]=s*a+h*i+_*n+t[13],e[14]=f*a+m*i+p*n+t[14],e[15]=l*a+u*i+x*n+t[15]),e}function Xt(e,t,r){var a=r[0],i=r[1],n=r[2];return e[0]=t[0]*a,e[1]=t[1]*a,e[2]=t[2]*a,e[3]=t[3]*a,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*n,e[9]=t[9]*n,e[10]=t[10]*n,e[11]=t[11]*n,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function qt(e,t,r,a){var i=a[0],n=a[1],o=a[2],s=Math.hypot(i,n,o),f,l,d,h,m,u,v,_,p,x,M,y,b,R,S,D,V,L,C,A,I,F,E,U;return s<w?null:(s=1/s,i*=s,n*=s,o*=s,f=Math.sin(r),l=Math.cos(r),d=1-l,h=t[0],m=t[1],u=t[2],v=t[3],_=t[4],p=t[5],x=t[6],M=t[7],y=t[8],b=t[9],R=t[10],S=t[11],D=i*i*d+l,V=n*i*d+o*f,L=o*i*d-n*f,C=i*n*d-o*f,A=n*n*d+l,I=o*n*d+i*f,F=i*o*d+n*f,E=n*o*d-i*f,U=o*o*d+l,e[0]=h*D+_*V+y*L,e[1]=m*D+p*V+b*L,e[2]=u*D+x*V+R*L,e[3]=v*D+M*V+S*L,e[4]=h*C+_*A+y*I,e[5]=m*C+p*A+b*I,e[6]=u*C+x*A+R*I,e[7]=v*C+M*A+S*I,e[8]=h*F+_*E+y*U,e[9]=m*F+p*E+b*U,e[10]=u*F+x*E+R*U,e[11]=v*F+M*E+S*U,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e)}function jt(e,t,r){var a=Math.sin(r),i=Math.cos(r),n=t[4],o=t[5],s=t[6],f=t[7],l=t[8],d=t[9],h=t[10],m=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=n*i+l*a,e[5]=o*i+d*a,e[6]=s*i+h*a,e[7]=f*i+m*a,e[8]=l*i-n*a,e[9]=d*i-o*a,e[10]=h*i-s*a,e[11]=m*i-f*a,e}function Kt(e,t,r){var a=Math.sin(r),i=Math.cos(r),n=t[0],o=t[1],s=t[2],f=t[3],l=t[8],d=t[9],h=t[10],m=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=n*i-l*a,e[1]=o*i-d*a,e[2]=s*i-h*a,e[3]=f*i-m*a,e[8]=n*a+l*i,e[9]=o*a+d*i,e[10]=s*a+h*i,e[11]=f*a+m*i,e}function $t(e,t,r){var a=Math.sin(r),i=Math.cos(r),n=t[0],o=t[1],s=t[2],f=t[3],l=t[4],d=t[5],h=t[6],m=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=n*i+l*a,e[1]=o*i+d*a,e[2]=s*i+h*a,e[3]=f*i+m*a,e[4]=l*i-n*a,e[5]=d*i-o*a,e[6]=h*i-s*a,e[7]=m*i-f*a,e}function Zt(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e}function Qt(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Jt(e,t,r){var a=r[0],i=r[1],n=r[2],o=Math.hypot(a,i,n),s,f,l;return o<w?null:(o=1/o,a*=o,i*=o,n*=o,s=Math.sin(t),f=Math.cos(t),l=1-f,e[0]=a*a*l+f,e[1]=i*a*l+n*s,e[2]=n*a*l-i*s,e[3]=0,e[4]=a*i*l-n*s,e[5]=i*i*l+f,e[6]=n*i*l+a*s,e[7]=0,e[8]=a*n*l+i*s,e[9]=i*n*l-a*s,e[10]=n*n*l+f,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e)}function er(e,t){var r=Math.sin(t),a=Math.cos(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=r,e[7]=0,e[8]=0,e[9]=-r,e[10]=a,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function tr(e,t){var r=Math.sin(t),a=Math.cos(t);return e[0]=a,e[1]=0,e[2]=-r,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=r,e[9]=0,e[10]=a,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function rr(e,t){var r=Math.sin(t),a=Math.cos(t);return e[0]=a,e[1]=r,e[2]=0,e[3]=0,e[4]=-r,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Ze(e,t,r){var a=t[0],i=t[1],n=t[2],o=t[3],s=a+a,f=i+i,l=n+n,d=a*s,h=a*f,m=a*l,u=i*f,v=i*l,_=n*l,p=o*s,x=o*f,M=o*l;return e[0]=1-(u+_),e[1]=h+M,e[2]=m-x,e[3]=0,e[4]=h-M,e[5]=1-(d+_),e[6]=v+p,e[7]=0,e[8]=m+x,e[9]=v-p,e[10]=1-(d+u),e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1,e}function ar(e,t){var r=new B(3),a=-t[0],i=-t[1],n=-t[2],o=t[3],s=t[4],f=t[5],l=t[6],d=t[7],h=a*a+i*i+n*n+o*o;return h>0?(r[0]=(s*o+d*a+f*n-l*i)*2/h,r[1]=(f*o+d*i+l*a-s*n)*2/h,r[2]=(l*o+d*n+s*i-f*a)*2/h):(r[0]=(s*o+d*a+f*n-l*i)*2,r[1]=(f*o+d*i+l*a-s*n)*2,r[2]=(l*o+d*n+s*i-f*a)*2),Ze(e,t,r),e}function ir(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function Qe(e,t){var r=t[0],a=t[1],i=t[2],n=t[4],o=t[5],s=t[6],f=t[8],l=t[9],d=t[10];return e[0]=Math.hypot(r,a,i),e[1]=Math.hypot(n,o,s),e[2]=Math.hypot(f,l,d),e}function nr(e,t){var r=new B(3);Qe(r,t);var a=1/r[0],i=1/r[1],n=1/r[2],o=t[0]*a,s=t[1]*i,f=t[2]*n,l=t[4]*a,d=t[5]*i,h=t[6]*n,m=t[8]*a,u=t[9]*i,v=t[10]*n,_=o+d+v,p=0;return _>0?(p=Math.sqrt(_+1)*2,e[3]=.25*p,e[0]=(h-u)/p,e[1]=(m-f)/p,e[2]=(s-l)/p):o>d&&o>v?(p=Math.sqrt(1+o-d-v)*2,e[3]=(h-u)/p,e[0]=.25*p,e[1]=(s+l)/p,e[2]=(m+f)/p):d>v?(p=Math.sqrt(1+d-o-v)*2,e[3]=(m-f)/p,e[0]=(s+l)/p,e[1]=.25*p,e[2]=(h+u)/p):(p=Math.sqrt(1+v-o-d)*2,e[3]=(s-l)/p,e[0]=(m+f)/p,e[1]=(h+u)/p,e[2]=.25*p),e}function sr(e,t,r,a){var i=t[0],n=t[1],o=t[2],s=t[3],f=i+i,l=n+n,d=o+o,h=i*f,m=i*l,u=i*d,v=n*l,_=n*d,p=o*d,x=s*f,M=s*l,y=s*d,b=a[0],R=a[1],S=a[2];return e[0]=(1-(v+p))*b,e[1]=(m+y)*b,e[2]=(u-M)*b,e[3]=0,e[4]=(m-y)*R,e[5]=(1-(h+p))*R,e[6]=(_+x)*R,e[7]=0,e[8]=(u+M)*S,e[9]=(_-x)*S,e[10]=(1-(h+v))*S,e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1,e}function or(e,t,r,a,i){var n=t[0],o=t[1],s=t[2],f=t[3],l=n+n,d=o+o,h=s+s,m=n*l,u=n*d,v=n*h,_=o*d,p=o*h,x=s*h,M=f*l,y=f*d,b=f*h,R=a[0],S=a[1],D=a[2],V=i[0],L=i[1],C=i[2],A=(1-(_+x))*R,I=(u+b)*R,F=(v-y)*R,E=(u-b)*S,U=(1-(m+x))*S,le=(p+M)*S,de=(v+y)*D,Ue=(p-M)*D,Oe=(1-(m+_))*D;return e[0]=A,e[1]=I,e[2]=F,e[3]=0,e[4]=E,e[5]=U,e[6]=le,e[7]=0,e[8]=de,e[9]=Ue,e[10]=Oe,e[11]=0,e[12]=r[0]+V-(A*V+E*L+de*C),e[13]=r[1]+L-(I*V+U*L+Ue*C),e[14]=r[2]+C-(F*V+le*L+Oe*C),e[15]=1,e}function fr(e,t){var r=t[0],a=t[1],i=t[2],n=t[3],o=r+r,s=a+a,f=i+i,l=r*o,d=a*o,h=a*s,m=i*o,u=i*s,v=i*f,_=n*o,p=n*s,x=n*f;return e[0]=1-h-v,e[1]=d+x,e[2]=m-p,e[3]=0,e[4]=d-x,e[5]=1-l-v,e[6]=u+_,e[7]=0,e[8]=m+p,e[9]=u-_,e[10]=1-l-h,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function lr(e,t,r,a,i,n,o){var s=1/(r-t),f=1/(i-a),l=1/(n-o);return e[0]=n*2*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n*2*f,e[6]=0,e[7]=0,e[8]=(r+t)*s,e[9]=(i+a)*f,e[10]=(o+n)*l,e[11]=-1,e[12]=0,e[13]=0,e[14]=o*n*2*l,e[15]=0,e}function Je(e,t,r,a,i){var n=1/Math.tan(t/2),o;return e[0]=n/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,i!=null&&i!==1/0?(o=1/(a-i),e[10]=(i+a)*o,e[14]=2*i*a*o):(e[10]=-1,e[14]=-2*a),e}var dr=Je;function cr(e,t,r,a,i){var n=1/Math.tan(t/2),o;return e[0]=n/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,i!=null&&i!==1/0?(o=1/(a-i),e[10]=i*o,e[14]=i*a*o):(e[10]=-1,e[14]=-a),e}function hr(e,t,r,a){var i=Math.tan(t.upDegrees*Math.PI/180),n=Math.tan(t.downDegrees*Math.PI/180),o=Math.tan(t.leftDegrees*Math.PI/180),s=Math.tan(t.rightDegrees*Math.PI/180),f=2/(o+s),l=2/(i+n);return e[0]=f,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=l,e[6]=0,e[7]=0,e[8]=-((o-s)*f*.5),e[9]=(i-n)*l*.5,e[10]=a/(r-a),e[11]=-1,e[12]=0,e[13]=0,e[14]=a*r/(r-a),e[15]=0,e}function et(e,t,r,a,i,n,o){var s=1/(t-r),f=1/(a-i),l=1/(n-o);return e[0]=-2*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*f,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*l,e[11]=0,e[12]=(t+r)*s,e[13]=(i+a)*f,e[14]=(o+n)*l,e[15]=1,e}var mr=et;function ur(e,t,r,a,i,n,o){var s=1/(t-r),f=1/(a-i),l=1/(n-o);return e[0]=-2*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*f,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=l,e[11]=0,e[12]=(t+r)*s,e[13]=(i+a)*f,e[14]=n*l,e[15]=1,e}function pr(e,t,r,a){var i,n,o,s,f,l,d,h,m,u,v=t[0],_=t[1],p=t[2],x=a[0],M=a[1],y=a[2],b=r[0],R=r[1],S=r[2];return Math.abs(v-b)<w&&Math.abs(_-R)<w&&Math.abs(p-S)<w?Ke(e):(d=v-b,h=_-R,m=p-S,u=1/Math.hypot(d,h,m),d*=u,h*=u,m*=u,i=M*m-y*h,n=y*d-x*m,o=x*h-M*d,u=Math.hypot(i,n,o),u?(u=1/u,i*=u,n*=u,o*=u):(i=0,n=0,o=0),s=h*o-m*n,f=m*i-d*o,l=d*n-h*i,u=Math.hypot(s,f,l),u?(u=1/u,s*=u,f*=u,l*=u):(s=0,f=0,l=0),e[0]=i,e[1]=s,e[2]=d,e[3]=0,e[4]=n,e[5]=f,e[6]=h,e[7]=0,e[8]=o,e[9]=l,e[10]=m,e[11]=0,e[12]=-(i*v+n*_+o*p),e[13]=-(s*v+f*_+l*p),e[14]=-(d*v+h*_+m*p),e[15]=1,e)}function vr(e,t,r,a){var i=t[0],n=t[1],o=t[2],s=a[0],f=a[1],l=a[2],d=i-r[0],h=n-r[1],m=o-r[2],u=d*d+h*h+m*m;u>0&&(u=1/Math.sqrt(u),d*=u,h*=u,m*=u);var v=f*m-l*h,_=l*d-s*m,p=s*h-f*d;return u=v*v+_*_+p*p,u>0&&(u=1/Math.sqrt(u),v*=u,_*=u,p*=u),e[0]=v,e[1]=_,e[2]=p,e[3]=0,e[4]=h*p-m*_,e[5]=m*v-d*p,e[6]=d*_-h*v,e[7]=0,e[8]=d,e[9]=h,e[10]=m,e[11]=0,e[12]=i,e[13]=n,e[14]=o,e[15]=1,e}function gr(e){return"mat4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"}function _r(e){return Math.hypot(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}function xr(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e[4]=t[4]+r[4],e[5]=t[5]+r[5],e[6]=t[6]+r[6],e[7]=t[7]+r[7],e[8]=t[8]+r[8],e[9]=t[9]+r[9],e[10]=t[10]+r[10],e[11]=t[11]+r[11],e[12]=t[12]+r[12],e[13]=t[13]+r[13],e[14]=t[14]+r[14],e[15]=t[15]+r[15],e}function tt(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e[4]=t[4]-r[4],e[5]=t[5]-r[5],e[6]=t[6]-r[6],e[7]=t[7]-r[7],e[8]=t[8]-r[8],e[9]=t[9]-r[9],e[10]=t[10]-r[10],e[11]=t[11]-r[11],e[12]=t[12]-r[12],e[13]=t[13]-r[13],e[14]=t[14]-r[14],e[15]=t[15]-r[15],e}function yr(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e[8]=t[8]*r,e[9]=t[9]*r,e[10]=t[10]*r,e[11]=t[11]*r,e[12]=t[12]*r,e[13]=t[13]*r,e[14]=t[14]*r,e[15]=t[15]*r,e}function br(e,t,r,a){return e[0]=t[0]+r[0]*a,e[1]=t[1]+r[1]*a,e[2]=t[2]+r[2]*a,e[3]=t[3]+r[3]*a,e[4]=t[4]+r[4]*a,e[5]=t[5]+r[5]*a,e[6]=t[6]+r[6]*a,e[7]=t[7]+r[7]*a,e[8]=t[8]+r[8]*a,e[9]=t[9]+r[9]*a,e[10]=t[10]+r[10]*a,e[11]=t[11]+r[11]*a,e[12]=t[12]+r[12]*a,e[13]=t[13]+r[13]*a,e[14]=t[14]+r[14]*a,e[15]=t[15]+r[15]*a,e}function Rr(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]&&e[11]===t[11]&&e[12]===t[12]&&e[13]===t[13]&&e[14]===t[14]&&e[15]===t[15]}function Sr(e,t){var r=e[0],a=e[1],i=e[2],n=e[3],o=e[4],s=e[5],f=e[6],l=e[7],d=e[8],h=e[9],m=e[10],u=e[11],v=e[12],_=e[13],p=e[14],x=e[15],M=t[0],y=t[1],b=t[2],R=t[3],S=t[4],D=t[5],V=t[6],L=t[7],C=t[8],A=t[9],I=t[10],F=t[11],E=t[12],U=t[13],le=t[14],de=t[15];return Math.abs(r-M)<=w*Math.max(1,Math.abs(r),Math.abs(M))&&Math.abs(a-y)<=w*Math.max(1,Math.abs(a),Math.abs(y))&&Math.abs(i-b)<=w*Math.max(1,Math.abs(i),Math.abs(b))&&Math.abs(n-R)<=w*Math.max(1,Math.abs(n),Math.abs(R))&&Math.abs(o-S)<=w*Math.max(1,Math.abs(o),Math.abs(S))&&Math.abs(s-D)<=w*Math.max(1,Math.abs(s),Math.abs(D))&&Math.abs(f-V)<=w*Math.max(1,Math.abs(f),Math.abs(V))&&Math.abs(l-L)<=w*Math.max(1,Math.abs(l),Math.abs(L))&&Math.abs(d-C)<=w*Math.max(1,Math.abs(d),Math.abs(C))&&Math.abs(h-A)<=w*Math.max(1,Math.abs(h),Math.abs(A))&&Math.abs(m-I)<=w*Math.max(1,Math.abs(m),Math.abs(I))&&Math.abs(u-F)<=w*Math.max(1,Math.abs(u),Math.abs(F))&&Math.abs(v-E)<=w*Math.max(1,Math.abs(v),Math.abs(E))&&Math.abs(_-U)<=w*Math.max(1,Math.abs(_),Math.abs(U))&&Math.abs(p-le)<=w*Math.max(1,Math.abs(p),Math.abs(le))&&Math.abs(x-de)<=w*Math.max(1,Math.abs(x),Math.abs(de))}var Tr=$e,Mr=tt;var g={};q(g,{add:()=>Cr,angle:()=>Qr,bezier:()=>Wr,ceil:()=>Lr,clone:()=>Er,copy:()=>Dr,create:()=>rt,cross:()=>Or,dist:()=>sa,distance:()=>ot,div:()=>na,divide:()=>st,dot:()=>dt,equals:()=>ra,exactEquals:()=>ta,floor:()=>Ar,forEach:()=>da,fromValues:()=>wr,hermite:()=>Gr,inverse:()=>Nr,len:()=>fa,length:()=>at,lerp:()=>Hr,max:()=>kr,min:()=>zr,mul:()=>ia,multiply:()=>nt,negate:()=>Br,normalize:()=>Ur,random:()=>Yr,rotateX:()=>Kr,rotateY:()=>$r,rotateZ:()=>Zr,round:()=>Ir,scale:()=>Pr,scaleAndAdd:()=>Fr,set:()=>Vr,sqrDist:()=>oa,sqrLen:()=>la,squaredDistance:()=>ft,squaredLength:()=>lt,str:()=>ea,sub:()=>aa,subtract:()=>it,transformMat3:()=>qr,transformMat4:()=>Xr,transformQuat:()=>jr,zero:()=>Jr});function rt(){var e=new B(3);return B!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function Er(e){var t=new B(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function at(e){var t=e[0],r=e[1],a=e[2];return Math.hypot(t,r,a)}function wr(e,t,r){var a=new B(3);return a[0]=e,a[1]=t,a[2]=r,a}function Dr(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function Vr(e,t,r,a){return e[0]=t,e[1]=r,e[2]=a,e}function Cr(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e}function it(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e}function nt(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e}function st(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e[2]=t[2]/r[2],e}function Lr(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e}function Ar(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e}function zr(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e[2]=Math.min(t[2],r[2]),e}function kr(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e[2]=Math.max(t[2],r[2]),e}function Ir(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e}function Pr(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e}function Fr(e,t,r,a){return e[0]=t[0]+r[0]*a,e[1]=t[1]+r[1]*a,e[2]=t[2]+r[2]*a,e}function ot(e,t){var r=t[0]-e[0],a=t[1]-e[1],i=t[2]-e[2];return Math.hypot(r,a,i)}function ft(e,t){var r=t[0]-e[0],a=t[1]-e[1],i=t[2]-e[2];return r*r+a*a+i*i}function lt(e){var t=e[0],r=e[1],a=e[2];return t*t+r*r+a*a}function Br(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e}function Nr(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e}function Ur(e,t){var r=t[0],a=t[1],i=t[2],n=r*r+a*a+i*i;return n>0&&(n=1/Math.sqrt(n)),e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e}function dt(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function Or(e,t,r){var a=t[0],i=t[1],n=t[2],o=r[0],s=r[1],f=r[2];return e[0]=i*f-n*s,e[1]=n*o-a*f,e[2]=a*s-i*o,e}function Hr(e,t,r,a){var i=t[0],n=t[1],o=t[2];return e[0]=i+a*(r[0]-i),e[1]=n+a*(r[1]-n),e[2]=o+a*(r[2]-o),e}function Gr(e,t,r,a,i,n){var o=n*n,s=o*(2*n-3)+1,f=o*(n-2)+n,l=o*(n-1),d=o*(3-2*n);return e[0]=t[0]*s+r[0]*f+a[0]*l+i[0]*d,e[1]=t[1]*s+r[1]*f+a[1]*l+i[1]*d,e[2]=t[2]*s+r[2]*f+a[2]*l+i[2]*d,e}function Wr(e,t,r,a,i,n){var o=1-n,s=o*o,f=n*n,l=s*o,d=3*n*s,h=3*f*o,m=f*n;return e[0]=t[0]*l+r[0]*d+a[0]*h+i[0]*m,e[1]=t[1]*l+r[1]*d+a[1]*h+i[1]*m,e[2]=t[2]*l+r[2]*d+a[2]*h+i[2]*m,e}function Yr(e,t){t=t||1;var r=ce()*2*Math.PI,a=ce()*2-1,i=Math.sqrt(1-a*a)*t;return e[0]=Math.cos(r)*i,e[1]=Math.sin(r)*i,e[2]=a*t,e}function Xr(e,t,r){var a=t[0],i=t[1],n=t[2],o=r[3]*a+r[7]*i+r[11]*n+r[15];return o=o||1,e[0]=(r[0]*a+r[4]*i+r[8]*n+r[12])/o,e[1]=(r[1]*a+r[5]*i+r[9]*n+r[13])/o,e[2]=(r[2]*a+r[6]*i+r[10]*n+r[14])/o,e}function qr(e,t,r){var a=t[0],i=t[1],n=t[2];return e[0]=a*r[0]+i*r[3]+n*r[6],e[1]=a*r[1]+i*r[4]+n*r[7],e[2]=a*r[2]+i*r[5]+n*r[8],e}function jr(e,t,r){var a=r[0],i=r[1],n=r[2],o=r[3],s=t[0],f=t[1],l=t[2],d=i*l-n*f,h=n*s-a*l,m=a*f-i*s,u=i*m-n*h,v=n*d-a*m,_=a*h-i*d,p=o*2;return d*=p,h*=p,m*=p,u*=2,v*=2,_*=2,e[0]=s+d+u,e[1]=f+h+v,e[2]=l+m+_,e}function Kr(e,t,r,a){var i=[],n=[];return i[0]=t[0]-r[0],i[1]=t[1]-r[1],i[2]=t[2]-r[2],n[0]=i[0],n[1]=i[1]*Math.cos(a)-i[2]*Math.sin(a),n[2]=i[1]*Math.sin(a)+i[2]*Math.cos(a),e[0]=n[0]+r[0],e[1]=n[1]+r[1],e[2]=n[2]+r[2],e}function $r(e,t,r,a){var i=[],n=[];return i[0]=t[0]-r[0],i[1]=t[1]-r[1],i[2]=t[2]-r[2],n[0]=i[2]*Math.sin(a)+i[0]*Math.cos(a),n[1]=i[1],n[2]=i[2]*Math.cos(a)-i[0]*Math.sin(a),e[0]=n[0]+r[0],e[1]=n[1]+r[1],e[2]=n[2]+r[2],e}function Zr(e,t,r,a){var i=[],n=[];return i[0]=t[0]-r[0],i[1]=t[1]-r[1],i[2]=t[2]-r[2],n[0]=i[0]*Math.cos(a)-i[1]*Math.sin(a),n[1]=i[0]*Math.sin(a)+i[1]*Math.cos(a),n[2]=i[2],e[0]=n[0]+r[0],e[1]=n[1]+r[1],e[2]=n[2]+r[2],e}function Qr(e,t){var r=e[0],a=e[1],i=e[2],n=t[0],o=t[1],s=t[2],f=Math.sqrt(r*r+a*a+i*i),l=Math.sqrt(n*n+o*o+s*s),d=f*l,h=d&&dt(e,t)/d;return Math.acos(Math.min(Math.max(h,-1),1))}function Jr(e){return e[0]=0,e[1]=0,e[2]=0,e}function ea(e){return"vec3("+e[0]+", "+e[1]+", "+e[2]+")"}function ta(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function ra(e,t){var r=e[0],a=e[1],i=e[2],n=t[0],o=t[1],s=t[2];return Math.abs(r-n)<=w*Math.max(1,Math.abs(r),Math.abs(n))&&Math.abs(a-o)<=w*Math.max(1,Math.abs(a),Math.abs(o))&&Math.abs(i-s)<=w*Math.max(1,Math.abs(i),Math.abs(s))}var aa=it,ia=nt,na=st,sa=ot,oa=ft,fa=at,la=lt,da=function(){var e=rt();return function(t,r,a,i,n,o){var s,f;for(r||(r=3),a||(a=0),i?f=Math.min(i*r+a,t.length):f=t.length,s=a;s<f;s+=r)e[0]=t[s],e[1]=t[s+1],e[2]=t[s+2],n(e,e,o),t[s]=e[0],t[s+1]=e[1],t[s+2]=e[2];return t}}();var he={};q(he,{add:()=>pa,angle:()=>Ia,ceil:()=>va,clone:()=>ca,copy:()=>ma,create:()=>ct,cross:()=>wa,dist:()=>Wa,distance:()=>pt,div:()=>Ga,divide:()=>ut,dot:()=>Ea,equals:()=>Na,exactEquals:()=>Ba,floor:()=>ga,forEach:()=>qa,fromValues:()=>ha,inverse:()=>Ta,len:()=>Ua,length:()=>gt,lerp:()=>Da,max:()=>xa,min:()=>_a,mul:()=>Ha,multiply:()=>mt,negate:()=>Sa,normalize:()=>Ma,random:()=>Va,rotate:()=>ka,round:()=>ya,scale:()=>ba,scaleAndAdd:()=>Ra,set:()=>ua,sqrDist:()=>Ya,sqrLen:()=>Xa,squaredDistance:()=>vt,squaredLength:()=>_t,str:()=>Fa,sub:()=>Oa,subtract:()=>ht,transformMat2:()=>Ca,transformMat2d:()=>La,transformMat3:()=>Aa,transformMat4:()=>za,zero:()=>Pa});function ct(){var e=new B(2);return B!=Float32Array&&(e[0]=0,e[1]=0),e}function ca(e){var t=new B(2);return t[0]=e[0],t[1]=e[1],t}function ha(e,t){var r=new B(2);return r[0]=e,r[1]=t,r}function ma(e,t){return e[0]=t[0],e[1]=t[1],e}function ua(e,t,r){return e[0]=t,e[1]=r,e}function pa(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e}function ht(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e}function mt(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e}function ut(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e}function va(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e}function ga(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e}function _a(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e}function xa(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e}function ya(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e}function ba(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e}function Ra(e,t,r,a){return e[0]=t[0]+r[0]*a,e[1]=t[1]+r[1]*a,e}function pt(e,t){var r=t[0]-e[0],a=t[1]-e[1];return Math.hypot(r,a)}function vt(e,t){var r=t[0]-e[0],a=t[1]-e[1];return r*r+a*a}function gt(e){var t=e[0],r=e[1];return Math.hypot(t,r)}function _t(e){var t=e[0],r=e[1];return t*t+r*r}function Sa(e,t){return e[0]=-t[0],e[1]=-t[1],e}function Ta(e,t){return e[0]=1/t[0],e[1]=1/t[1],e}function Ma(e,t){var r=t[0],a=t[1],i=r*r+a*a;return i>0&&(i=1/Math.sqrt(i)),e[0]=t[0]*i,e[1]=t[1]*i,e}function Ea(e,t){return e[0]*t[0]+e[1]*t[1]}function wa(e,t,r){var a=t[0]*r[1]-t[1]*r[0];return e[0]=e[1]=0,e[2]=a,e}function Da(e,t,r,a){var i=t[0],n=t[1];return e[0]=i+a*(r[0]-i),e[1]=n+a*(r[1]-n),e}function Va(e,t){t=t||1;var r=ce()*2*Math.PI;return e[0]=Math.cos(r)*t,e[1]=Math.sin(r)*t,e}function Ca(e,t,r){var a=t[0],i=t[1];return e[0]=r[0]*a+r[2]*i,e[1]=r[1]*a+r[3]*i,e}function La(e,t,r){var a=t[0],i=t[1];return e[0]=r[0]*a+r[2]*i+r[4],e[1]=r[1]*a+r[3]*i+r[5],e}function Aa(e,t,r){var a=t[0],i=t[1];return e[0]=r[0]*a+r[3]*i+r[6],e[1]=r[1]*a+r[4]*i+r[7],e}function za(e,t,r){var a=t[0],i=t[1];return e[0]=r[0]*a+r[4]*i+r[12],e[1]=r[1]*a+r[5]*i+r[13],e}function ka(e,t,r,a){var i=t[0]-r[0],n=t[1]-r[1],o=Math.sin(a),s=Math.cos(a);return e[0]=i*s-n*o+r[0],e[1]=i*o+n*s+r[1],e}function Ia(e,t){var r=e[0],a=e[1],i=t[0],n=t[1],o=Math.sqrt(r*r+a*a)*Math.sqrt(i*i+n*n),s=o&&(r*i+a*n)/o;return Math.acos(Math.min(Math.max(s,-1),1))}function Pa(e){return e[0]=0,e[1]=0,e}function Fa(e){return"vec2("+e[0]+", "+e[1]+")"}function Ba(e,t){return e[0]===t[0]&&e[1]===t[1]}function Na(e,t){var r=e[0],a=e[1],i=t[0],n=t[1];return Math.abs(r-i)<=w*Math.max(1,Math.abs(r),Math.abs(i))&&Math.abs(a-n)<=w*Math.max(1,Math.abs(a),Math.abs(n))}var Ua=gt,Oa=ht,Ha=mt,Ga=ut,Wa=pt,Ya=vt,Xa=_t,qa=function(){var e=ct();return function(t,r,a,i,n,o){var s,f;for(r||(r=2),a||(a=0),i?f=Math.min(i*r+a,t.length):f=t.length,s=a;s<f;s+=r)e[0]=t[s],e[1]=t[s+1],n(e,e,o),t[s]=e[0],t[s+1]=e[1];return t}}();var K=[.2,.2,.2],$=[.2,.6,.2],ja=(e,t)=>{e.push({center:[t[0],t[1]],size:[40,40],text:"A\nQ",color:z.isPressed("A","Q")?$:K}),e.push({center:[t[0]+45*1,t[1]],size:[40,40],text:"S",color:z.isPressed("S")?$:K}),e.push({center:[t[0]+45*1,t[1]+45],size:[40,40],text:"W\nZ",color:z.isPressed("W","Z")?$:K}),e.push({center:[t[0]+45*2,t[1]],size:[40,40],text:"D",color:z.isPressed("D")?$:K})},Ka=(e,t)=>{e.push({center:[t[0],t[1]],size:[40,40],lines:[{a:[15,0],b:[-8,0],thickness:6,color:[1,1,1]},{a:[0,10],b:[-12,-2],thickness:6,color:[1,1,1]},{a:[0,-10],b:[-12,2],thickness:6,color:[1,1,1]}],color:z.isPressed("ArrowLeft")?$:K}),e.push({center:[t[0]+45,t[1]],size:[40,40],lines:[{a:[0,15],b:[0,-8],thickness:6,color:[1,1,1]},{a:[10,0],b:[-2,-12],thickness:6,color:[1,1,1]},{a:[-10,0],b:[2,-12],thickness:6,color:[1,1,1]}],color:z.isPressed("ArrowDown")?$:K}),e.push({center:[t[0]+45,t[1]+45],size:[40,40],lines:[{a:[0,-15],b:[0,8],thickness:6,color:[1,1,1]},{a:[10,0],b:[-2,12],thickness:6,color:[1,1,1]},{a:[-10,0],b:[2,12],thickness:6,color:[1,1,1]}],color:z.isPressed("ArrowUp")?$:K}),e.push({center:[t[0]+45*2,t[1]],size:[40,40],lines:[{a:[-15,0],b:[8,0],thickness:6,color:[1,1,1]},{a:[0,10],b:[12,-2],thickness:6,color:[1,1,1]},{a:[0,-10],b:[12,2],thickness:6,color:[1,1,1]}],color:z.isPressed("ArrowRight")?$:K})},$a=(e,t,r)=>{J.isSupported(t)?e.push({center:[r[0]+115,r[1]],size:[230,60],text:"Touch Events\nSupported\n(double tap)",color:[0,.5,0]}):e.push({center:[r[0]+115,r[1]],size:[230,60],text:"Touch Events\nNot Supported",color:[.5,0,0]}),j.canBePointerLocked(t)?e.push({center:[r[0]+105,r[1]+70],size:[210,60],text:"Mouse\nSupported",color:[0,.5,0]}):e.push({center:[r[0]+105,r[1]+70],size:[210,60],text:"Mouse Events\nNot Supported",color:[.5,0,0]})},xt=(e,t,r)=>{let a=[],i=[27,165],n=[7+20,260],o=[7,35];ja(a,i),Ka(a,n),$a(a,e,o),a.forEach(s=>{let{center:f}=s;t.pushCenteredRectangle(g.fromValues(f[0],f[1],-.3),s.size,[0,0,0]),t.pushCenteredRectangle(g.fromValues(f[0],f[1],-.2),[s.size[0]-2,s.size[1]-2],s.color),s.text&&r.setTextScale(16).setTextAlign("centered","centered").pushText(s.text,f).setTextAlign("left","top"),s.lines&&s.lines.forEach(l=>{t.pushThickLine([f[0]+l.a[0],f[1]+l.a[1],0],[f[0]+l.b[0],f[1]+l.b[1],0],l.thickness,l.color)})})};var ie={X:0,Y:1,Z:2},ye=class{constructor(t){this._isActivated=!1;this._theta=0;this._phi=0;this._touchWasActive=!1;this._touchStartTime=0;this._touchMoveForward=!1;this._position=g.fromValues(0,0,0);this._target=g.fromValues(0,0,0);this._forwardAxis=g.fromValues(1,0,0);this._leftAxis=g.fromValues(0,0,1);this._upAxis=g.fromValues(0,1,0);this._mouseSensibility=t.mouseSensibility,this._keyboardSensibility=t.keyboardSensibility,this._touchSensibility=t.touchSensibility,this._movingSpeed=t.movingSpeed,g.copy(this._position,t.position),this._axisIndices=[t.coordinates?ie[t.coordinates[0]]:ie.X,t.coordinates?ie[t.coordinates[1]]:ie.Y,t.coordinates?ie[t.coordinates[2]]:ie.Z],this._theta=t.theta,this._phi=t.phi}isActivated(){return this._isActivated}update(t){let r=!1,a=!1,i=!1,n=!1,o=0,s=0,f=Math.PI/180;{let D=Q.deltaX()*this._mouseSensibility,V=Q.deltaY()*this._mouseSensibility;o-=D*f,s-=V*f}let l=J.getTouchData().length>0;if(l){if(!this._touchWasActive){let C=Date.now();(C-this._touchStartTime)/1e3<.25?this._touchMoveForward=!0:this._touchStartTime=C}let D=J.getTouchData()[0],V=D.deltaX*this._touchSensibility,L=D.deltaY*this._touchSensibility;o-=V*f,s-=L*f}else this._touchMoveForward=!1;this._touchWasActive=l,this._touchMoveForward&&(r=!0);let d=this._movingSpeed*t,h=g.fromValues(0,0,0);g.scale(h,this._forwardAxis,d);let m=g.fromValues(0,0,0);g.scale(m,this._leftAxis,d),z.isPressed("Z","W")&&(r=!0),z.isPressed("S")&&(a=!0),z.isPressed("A","Q")&&(i=!0),z.isPressed("D")&&(n=!0);let u=this._keyboardSensibility*t;z.isPressed("ArrowUp")?s+=u:z.isPressed("ArrowDown")&&(s-=u),z.isPressed("ArrowLeft")?o+=u:z.isPressed("ArrowRight")&&(o-=u),this._theta+=o,this._phi+=s;let v=Math.PI*.5,_=v*.95;this._phi=Math.min(Math.max(this._phi,-_),+_);let p=Math.cos(this._theta),x=Math.sin(this._theta),[M,y,b]=this._axisIndices,R=Math.cos(this._phi+v);this._upAxis[M]=R*p,this._upAxis[y]=R*x,this._upAxis[b]=Math.sin(this._phi+v);let S=Math.cos(this._phi);this._forwardAxis[M]=S*p,this._forwardAxis[y]=S*x,this._forwardAxis[b]=Math.sin(this._phi),g.cross(this._leftAxis,this._upAxis,this._forwardAxis),r?g.add(this._position,this._position,h):a&&g.sub(this._position,this._position,h),i?g.add(this._position,this._position,m):n&&g.sub(this._position,this._position,m),g.add(this._target,this._position,this._forwardAxis)}getPosition(){return this._position}setPosition(t){g.copy(this._position,t)}getTarget(){return this._target}getForwardAxis(){return this._forwardAxis}getLeftAxis(){return this._leftAxis}getUpAxis(){return this._upAxis}getTheta(){return this._theta}getPhi(){return this._phi}getTouchMoveForward(){return this._touchMoveForward}};var me=class{constructor(){this._projectionType=0;this._viewportPos=he.fromValues(0,0);this._viewportSize=he.fromValues(0,0);this._projectionMatrix=k.create();this._viewMatrix=k.create();this._composedMatrix=k.create();this._eye=g.fromValues(0,0,0);this._target=g.fromValues(0,0,0);this._upAxis=g.fromValues(0,0,0)}setAsPerspective(t){this._projectionType=0;let r=t.aspectRatio;r===void 0&&(r=this._viewportSize[0]/this._viewportSize[1]),this._perspectiveData={fovy:t.fovy,aspectRatio:r,near:t.near,far:t.far}}setAsOrthogonal(t){this._projectionType=1,this._orthogonalData=ee({},t)}setViewportPos(t,r){this._viewportPos[0]=t,this._viewportPos[1]=r}getViewportPos(){return this._viewportPos}setViewportSize(t,r){this._viewportSize[0]=t,this._viewportSize[1]=r,this._projectionType!==0&&this._perspectiveData&&(this._perspectiveData.aspectRatio=this._viewportSize[0]/this._viewportSize[1])}getViewportSize(){return this._viewportSize}lookAt(t,r,a){g.copy(this._eye,t),g.copy(this._target,r),g.copy(this._upAxis,a)}setEye(t){g.copy(this._eye,t)}setTarget(t){g.copy(this._target,t)}setUpAxis(t){g.copy(this._upAxis,t)}getEye(){return this._eye}getTarget(){return this._target}getUpAxis(){return this._upAxis}addOffset(t){g.add(this._eye,this._eye,t),g.add(this._target,this._target,t)}subOffset(t){g.subtract(this._eye,this._eye,t),g.subtract(this._target,this._target,t)}computeMatrices(){if(this._projectionType===0){let{fovy:t,aspectRatio:r,near:a,far:i}=this._perspectiveData;k.perspective(this._projectionMatrix,t,r,a,i)}else if(this._projectionType===1){let{left:t,right:r,top:a,bottom:i,near:n,far:o}=this._orthogonalData;k.ortho(this._projectionMatrix,t,r,a,i,n,o)}k.lookAt(this._viewMatrix,this._eye,this._target,this._upAxis),this.computeComposedMatrix()}computeComposedMatrix(){k.multiply(this._composedMatrix,this._projectionMatrix,this._viewMatrix)}setProjectionMatrix(t){k.copy(this._projectionMatrix,t)}setViewMatrix(t){k.copy(this._viewMatrix,t)}setComposedMatrix(t){k.copy(this._composedMatrix,t)}getProjectionMatrix(){return this._projectionMatrix}getViewMatrix(){return this._viewMatrix}getComposedMatrix(){return this._composedMatrix}getPerspectiveData(){if(this._projectionType!==0)throw new Error("not a perspective projection");return this._perspectiveData}getOrthogonalData(){if(this._projectionType!==1)throw new Error("not an orthogonal projection");return this._orthogonalData}};var ne={};q(ne,{fragment:()=>Qa,vertex:()=>Za});var Za="\n#version 300 es\n\nprecision highp float;\n\nuniform mat4 u_composedMatrix;\n\nin vec3 a_vertex_position;\nin vec4 a_vertex_color;\n\nflat out vec4 v_color;\n\nvoid main(void)\n{\n  gl_Position = u_composedMatrix * vec4(a_vertex_position, 1.0);\n\n  v_color = a_vertex_color;\n}\n".trim(),Qa="\n#version 300 es\n\nprecision lowp float;\n\nflat in vec4 v_color;\n\nout vec4 o_color;\n\nvoid main(void)\n{\n  o_color = v_color;\n}\n\n".trim();var yt=14*1024,be=class{constructor(t,r){this._buffer=new Float32Array(yt);this._currentSize=0;this._shader=t;let a=ve(ee({},r),{primitiveType:P.PrimitiveType.lines});this._geometry=new P.Geometry(t,a),this._geometry.setFloatBufferSize(0,yt)}pushLine(t,r,a){var n;if(this._currentSize+7*2>=this._buffer.length)if(this._shader.isBound())this.flush();else return;let i=(n=a[3])!=null?n:1;this._buffer[this._currentSize+0]=t[0],this._buffer[this._currentSize+1]=t[1],this._buffer[this._currentSize+2]=t[2],this._buffer[this._currentSize+3]=a[0],this._buffer[this._currentSize+4]=a[1],this._buffer[this._currentSize+5]=a[2],this._buffer[this._currentSize+6]=i,this._currentSize+=7,this._buffer[this._currentSize+0]=r[0],this._buffer[this._currentSize+1]=r[1],this._buffer[this._currentSize+2]=r[2],this._buffer[this._currentSize+3]=a[0],this._buffer[this._currentSize+4]=a[1],this._buffer[this._currentSize+5]=a[2],this._buffer[this._currentSize+6]=i,this._currentSize+=7}canRender(){return this._currentSize>0}flush(){this.canRender()&&(this._geometry.updateBuffer(0,this._buffer,this._currentSize),this._geometry.setPrimitiveCount(this._currentSize/7),this._geometry.render(),this.clear())}clear(){this._currentSize=0}};var bt=7*1024,Re=class{constructor(t,r){this._buffer=new Float32Array(bt);this._currentSize=0;this._shader=t;let a=ve(ee({},r),{primitiveType:P.PrimitiveType.triangles});this._geometry=new P.Geometry(t,a),this._geometry.setFloatBufferSize(0,bt)}pushTriangle(t,r,a,i){var o;if(this._currentSize+7*6>=this._buffer.length)if(this._shader.isBound())this.flush();else return;let n=(o=i[3])!=null?o:1;this._buffer[this._currentSize+0]=t[0],this._buffer[this._currentSize+1]=t[1],this._buffer[this._currentSize+2]=t[2],this._buffer[this._currentSize+3]=i[0],this._buffer[this._currentSize+4]=i[1],this._buffer[this._currentSize+5]=i[2],this._buffer[this._currentSize+6]=n,this._currentSize+=7,this._buffer[this._currentSize+0]=r[0],this._buffer[this._currentSize+1]=r[1],this._buffer[this._currentSize+2]=r[2],this._buffer[this._currentSize+3]=i[0],this._buffer[this._currentSize+4]=i[1],this._buffer[this._currentSize+5]=i[2],this._buffer[this._currentSize+6]=n,this._currentSize+=7,this._buffer[this._currentSize+0]=a[0],this._buffer[this._currentSize+1]=a[1],this._buffer[this._currentSize+2]=a[2],this._buffer[this._currentSize+3]=i[0],this._buffer[this._currentSize+4]=i[1],this._buffer[this._currentSize+5]=i[2],this._buffer[this._currentSize+6]=n,this._currentSize+=7}pushLine(t,r,a,i){if(this._currentSize+7*6>=this._buffer.length)return;let n=r[0]-t[0],o=r[1]-t[1],s=Math.atan2(o,n)+Math.PI*.5,f=Math.cos(s)*a*.5,l=Math.sin(s)*a*.5;this.pushTriangle([t[0]-f,t[1]-l,t[2]],[r[0]-f,r[1]-l,r[2]],[r[0]+f,r[1]+l,r[2]],i),this.pushTriangle([t[0]-f,t[1]-l,t[2]],[r[0]+f,r[1]+l,r[2]],[t[0]+f,t[1]+l,t[2]],i)}pushRotatedLine(t,r,a,i,n){this.pushLine([t[0]-a*Math.cos(r),t[1]-a*Math.sin(r),t[2]],[t[0]+a*Math.cos(r),t[1]+a*Math.sin(r),t[2]],i,n)}pushOriginBoundRectangle(t,r,a){if(this._currentSize+7*6>=this._buffer.length)return;let i=[t[0]+r[0],t[1]+r[1]];this.pushTriangle([t[0],t[1],t[2]],[i[0],i[1],t[2]],[t[0],i[1],t[2]],a),this.pushTriangle([t[0],t[1],t[2]],[i[0],t[1],t[2]],[i[0],i[1],t[2]],a)}pushCenteredRectangle(t,r,a){let i=[t[0]-r[0]*.5,t[1]-r[1]*.5,t[2]];this.pushOriginBoundRectangle(i,r,a)}canRender(){return this._currentSize>0}flush(){this.canRender()&&(this._geometry.updateBuffer(0,this._buffer,this._currentSize),this._geometry.setPrimitiveCount(this._currentSize/7),this._geometry.render(),this.clear())}clear(){this._currentSize=0}};var Se=class{constructor(){this._shader=new O("StackRenderers",{vertexSrc:ne.vertex,fragmentSrc:ne.fragment,attributes:["a_vertex_position","a_vertex_color"],uniforms:["u_composedMatrix"]});let t=new P.GeometryBuilder;t.reset().setPrimitiveType("lines").addVbo().setVboAsDynamic().addVboAttribute("a_vertex_position","vec3f").addVboAttribute("a_vertex_color","vec4f"),this._wireFramesStackRenderer=new be(this._shader,t.getDef()),this._trianglesStackRenderer=new Re(this._shader,t.getDef())}pushLine(t,r,a){this._wireFramesStackRenderer.pushLine(t,r,a)}pushCross(t,r,a){let i=[[t[0]-r,t[1],t[2]],[t[0]+r,t[1],t[2]],[t[0],t[1]-r,t[2]],[t[0],t[1]+r,t[2]],[t[0],t[1],t[2]-r],[t[0],t[1],t[2]+r]],n=[0,1,2,3,4,5];for(let o=0;o<n.length;o+=2){let s=i[o+0],f=i[o+1];this._wireFramesStackRenderer.pushLine(s,f,a)}}pushThickLine(t,r,a,i){this._trianglesStackRenderer.pushLine(t,r,a,i)}pushRotatedLine(t,r,a,i,n){this._trianglesStackRenderer.pushRotatedLine(t,r,a,i,n)}pushOriginBoundRectangle(t,r,a){this._trianglesStackRenderer.pushOriginBoundRectangle(t,r,a)}pushCenteredRectangle(t,r,a){this._trianglesStackRenderer.pushCenteredRectangle(t,r,a)}pushTriangle(t,r,a,i){this._trianglesStackRenderer.pushTriangle(t,r,a,i)}flush(t){!this._wireFramesStackRenderer.canRender()&&!this._trianglesStackRenderer.canRender()||this._shader.bind(()=>{this._shader.setMatrix4Uniform("u_composedMatrix",t),this._wireFramesStackRenderer.flush(),this._trianglesStackRenderer.flush()})}safeRender(t,r){this._shader.bind(()=>{this._shader.setMatrix4Uniform("u_composedMatrix",t),r(),this._wireFramesStackRenderer.flush(),this._trianglesStackRenderer.flush()})}clear(){this._wireFramesStackRenderer.clear(),this._trianglesStackRenderer.clear()}};var se={};q(se,{fragment:()=>ti,vertex:()=>ei});var ei="\n\n#version 300 es\n\nprecision highp float;\n\nin vec2 a_vertexPosition;\nin vec3 a_plotPosition;\n\nout vec3 v_position;\n\nvoid main(void)\n{\n  gl_Position = vec4(a_vertexPosition, 1.0, 1.0);\n\n  v_position = a_plotPosition;\n}\n\n".trim(),ti='\n\n#version 300 es\n\nprecision highp float;\n\n//\n//\n//\n\nuniform vec3        u_cameraEye;\n\n//\n\nuniform sampler2D   u_sceneTextureData;\nuniform int         u_sceneTextureSize;\n\nuniform int       u_spheresStart;\nuniform int       u_spheresStop;\n\nuniform int       u_boxesStart;\nuniform int       u_boxesStop;\n\nuniform int       u_trianglesStart;\nuniform int       u_trianglesStop;\n\n//\n\nuniform sampler2D   u_lightsTextureData;\n\nuniform int       u_sunLightsStart;\nuniform int       u_sunLightsStop;\n\nuniform int       u_spotLightsStart;\nuniform int       u_spotLightsStop;\n\n//\n//\n//\n\nin vec3  v_position;\n\nout vec4 o_color;\n\n//\n\nconst float     g_ambiantLight = 0.2;\n\nconst int       g_reflectionMax = 2;\nconst bool      g_shadowsEnabled = true;\n\nconst vec3      g_backgroundColor = vec3(0.4);\n\n//\n\nstruct RayValues\n{\n  vec3 origin;\n  vec3 direction;\n};\n\nstruct RayResult\n{\n  bool hasHit;\n  float depth;\n  vec3 position;\n  vec3 normal;\n  vec4 color;\n  float reflection;\n  bool lightEnabled;\n};\n\n//\n//\n//\n//\n//\n\nfloat getSceneDataByIndex(int index)\n{\n  return texelFetch(u_sceneTextureData, ivec2(index, 0), 0).x;\n}\n\nvec3 getSceneVec3ByIndex(int index)\n{\n  return vec3(\n    texelFetch(u_sceneTextureData, ivec2(index + 0, 0), 0).x,\n    texelFetch(u_sceneTextureData, ivec2(index + 1, 0), 0).x,\n    texelFetch(u_sceneTextureData, ivec2(index + 2, 0), 0).x\n  );\n}\n\nfloat getLightsDataByIndex(int index)\n{\n  return texelFetch(u_lightsTextureData, ivec2(index, 0), 0).x;\n}\n\nvec3 getLightsVec3ByIndex(int index)\n{\n  return vec3(\n    texelFetch(u_lightsTextureData, ivec2(index + 0, 0), 0).x,\n    texelFetch(u_lightsTextureData, ivec2(index + 1, 0), 0).x,\n    texelFetch(u_lightsTextureData, ivec2(index + 2, 0), 0).x\n  );\n}\n\n//\n//\n//\n//\n//\n\nbool intersectSphere(RayValues ray, float radius, out float distance, out vec3 normal)\n{\n  float nearValue = 0.001; // TODO: hardcoded\n  float farValue = 100.0; // TODO: hardcoded\n\n  float b = dot(ray.origin, ray.direction);\n  float c = dot(ray.origin, ray.origin) - radius * radius;\n  float h = b * b - c;\n  if (h < 0.0)\n    return false;\n\n  h = sqrt(h);\n\n  float d1 = -b - h;\n  if (d1 >= nearValue && d1 <= farValue)\n  {\n    normal = normalize(ray.origin + ray.direction * d1);\n    distance = d1;\n    return true;\n  }\n\n  float d2 = -b + h;\n  if (d2 >= nearValue && d2 <= farValue)\n  {\n    normal = normalize(ray.origin + ray.direction * d2);\n    distance = d2;\n    return true;\n  }\n\n  return false;\n}\n\nbool intersectBox(RayValues ray, vec3 boxSize, out float distance, out vec3 normal)\n{\n  float nearValue = 0.001; // TODO: hardcoded\n  float farValue = 100.0; // TODO: hardcoded\n\n  //\n  //\n  // sad hack: fix a shadow related bug\n\n  if (ray.direction.x == 0.0) ray.direction.x = -1e-8;\n  if (ray.direction.y == 0.0) ray.direction.y = -1e-8;\n  if (ray.direction.z == 0.0) ray.direction.z = -1e-8;\n\n  // sad hack: fix a shadow related bug\n  //\n  //\n\n  vec3 m = sign(ray.direction) / max(abs(ray.direction), 1e-8);\n  vec3 n = m * ray.origin;\n  vec3 k = abs(m) * boxSize;\n\n  vec3 t1 = -n - k;\n  vec3 t2 = -n + k;\n\n  float tN = max(max(t1.x, t1.y), t1.z);\n  float tF = min(min(t2.x, t2.y), t2.z);\n\n  if (tN > tF || tF <= 0.0)\n    return false;\n\n  if (tN >= nearValue && tN <= farValue)\n  {\n    normal = normalize(-sign(ray.direction) * step(t1.yzx, t1.xyz) * step(t1.zxy, t1.xyz));\n    distance = tN;\n    return true;\n  }\n\n  if (tF >= nearValue && tF <= farValue)\n  {\n    normal = normalize(-sign(ray.direction) * step(t1.yzx, t1.xyz) * step(t1.zxy, t1.xyz));\n    distance = tF;\n    return true;\n  }\n\n  return false;\n}\n\nbool intersectTriangle(RayValues ray, vec3 v0, vec3 v1, vec3 v2, out float distance, out vec3 normal)\n{\n  float nearValue = 0.001; // TODO: hardcoded\n  float farValue = 100.0; // TODO: hardcoded\n\n  vec3 v1v0 = v1 - v0;\n  vec3 v2v0 = v2 - v0;\n  vec3 rov0 = ray.origin - v0;\n\n  vec3 n = cross(v1v0, v2v0);\n  vec3 q = cross(rov0, ray.direction);\n  float d = 1.0 / dot(ray.direction, n);\n  float u = d * dot(-q, v2v0);\n  float v = d * dot(q, v1v0);\n  float t = d * dot(-n, rov0);\n\n  if (u < 0.0 || v < 0.0 || (u + v) > 1.0 || t < nearValue || t > farValue)\n    return false;\n\n  normal = normalize(-n);\n  distance = t;\n  return true;\n}\n\n// float intersectPlane(RayValues ray, vec3 normal, float offset)\n// {\n//     return -(dot(ray.origin, normal) + offset) / dot(ray.direction, normal);\n// }\n\n// float intersectPlane2(RayValues ray, vec3 normal, float offset)\n// {\n//     float nearValue = 0.001; // TODO: hardcoded\n//     float farValue = 1000.0; // TODO: hardcoded\n\n//     float a = dot(ray.direction, normal);\n//     float d = -(dot(ray.origin, normal) + offset) / a;\n\n//     if (a > 0.0 || d < nearValue || d > farValue)\n//         return -1.0;\n\n//     return d;\n// }\n\n// float diskIntersect(RayValues ray, vec3 center, vec3 normal, float radius)\n// {\n//     vec3  o = ray.origin - center;\n//     float t = -dot(normal, o) / dot(ray.direction, normal);\n//     vec3  q = o + ray.direction * t;\n//     return (dot(q, q) < radius * radius) ? t : -1.0;\n// }\n\n//\n//\n//\n//\n//\n\nbool intersectScene(RayValues ray, out RayResult result, bool shadowMode)\n{\n  float bestDistance = -1.0;\n\n  result.hasHit = false;\n\n  if (u_sceneTextureSize <= 0)\n    return false;\n\n  RayValues tmpRay;\n  vec3 normal;\n\n  for (int index = u_spheresStart; index < u_spheresStop; index += 11)\n  {\n    bool shadowEnabled = (getSceneDataByIndex(index + 8) != 0.0);\n\n    if (shadowMode && !shadowEnabled)\n      continue;\n\n    tmpRay.origin = ray.origin;\n    tmpRay.direction = ray.direction;\n\n    vec3 center = getSceneVec3ByIndex(index + 0);\n\n    tmpRay.origin -= center;\n\n    float radius = getSceneDataByIndex(index + 3);\n\n    float currDistance = 0.0;\n    if (!intersectSphere(tmpRay, radius, currDistance, normal) || (bestDistance > 0.0 && currDistance > bestDistance))\n      continue;\n\n    bestDistance = currDistance;\n\n    result.hasHit = true;\n    result.depth = bestDistance;\n    result.position = ray.origin + bestDistance * ray.direction;\n    result.normal = normal;\n\n    bool chessboardMaterial = (getSceneDataByIndex(index + 10) != 0.0);\n\n    if (chessboardMaterial)\n    {\n      // vec3 txPos = (txx * vec4(result.position - center, 1.0)).xyz;\n      vec3 txPos = (vec4(result.position - center, 1.0)).xyz;\n      // chessboard color effect\n      if (fract(txPos.x * 0.2) > 0.5 == fract(txPos.z * 0.2) > 0.5 == fract(txPos.y * 0.2) > 0.5)\n      {\n        result.color = vec4(1.0);\n        result.reflection = 0.3;\n      }\n      else\n      {\n        result.color = vec4(0.0, 0.4, 0.45, 1.0);\n        result.reflection = 0.0;\n      }\n    }\n    else\n    {\n      vec3 color = getSceneVec3ByIndex(index + 4);\n\n      float reflection = getSceneDataByIndex(index + 7);\n\n      result.color = vec4(color, 0.5);\n      result.reflection = reflection;\n    }\n\n    bool lightEnabled = (getSceneDataByIndex(index + 9) != 0.0);\n    result.lightEnabled = lightEnabled;\n\n    // if (shadowMode)\n    //     return true;\n  }\n\n  for (int index = u_boxesStart; index < u_boxesStop; index += 26)\n  {\n    bool shadowEnabled = (getSceneDataByIndex(index + 23) != 0.0);\n\n    if (shadowMode && !shadowEnabled)\n      continue;\n\n    tmpRay.origin = ray.origin;\n    tmpRay.direction = ray.direction;\n\n    mat4 normalTransformationMatrix = mat4(\n      getSceneDataByIndex(index + 0),\n      getSceneDataByIndex(index + 1),\n      getSceneDataByIndex(index + 2),\n      getSceneDataByIndex(index + 3),\n\n      getSceneDataByIndex(index + 4),\n      getSceneDataByIndex(index + 5),\n      getSceneDataByIndex(index + 6),\n      getSceneDataByIndex(index + 7),\n\n      getSceneDataByIndex(index + 8),\n      getSceneDataByIndex(index + 9),\n      getSceneDataByIndex(index + 10),\n      getSceneDataByIndex(index + 11),\n\n      getSceneDataByIndex(index + 12),\n      getSceneDataByIndex(index + 13),\n      getSceneDataByIndex(index + 14),\n      getSceneDataByIndex(index + 15)\n    );\n\n    vec3 boxSize = getSceneVec3ByIndex(index + 16);\n\n    mat4 inversedTransformationMatrix = inverse(normalTransformationMatrix);\n\n    // convert ray from world space to box space\n    tmpRay.origin = (inversedTransformationMatrix * vec4(tmpRay.origin, 1.0)).xyz;\n    tmpRay.direction = (inversedTransformationMatrix * vec4(tmpRay.direction, 0.0)).xyz;\n\n    float currDistance = 0.0;\n    if (!intersectBox(tmpRay, boxSize, currDistance, normal) || (bestDistance > 0.0 && currDistance > bestDistance))\n      continue;\n\n    bestDistance = currDistance;\n\n    // convert normal from box space to world space\n    normal = (normalTransformationMatrix * vec4(normal, 0.0)).xyz;\n\n    result.hasHit = true;\n    result.depth = bestDistance;\n    result.position = ray.origin + bestDistance * ray.direction;\n    result.normal = normal;\n\n    bool chessboardMaterial = (getSceneDataByIndex(index + 25) != 0.0);\n\n    if (chessboardMaterial)\n    {\n      vec3 txPos = (inversedTransformationMatrix * vec4(result.position, 1.0)).xyz;\n\n      // chessboard color effect\n      if (fract(txPos.x * 0.2) > 0.5 == fract(txPos.z * 0.2) > 0.5 == fract(txPos.y * 0.2) > 0.5)\n      {\n        result.color = vec4(1.0);\n        result.reflection = 0.3;\n      }\n      else\n      {\n        result.color = vec4(0.0, 0.4, 0.45, 1.0);\n        result.reflection = 0.0;\n      }\n    }\n    else\n    {\n      vec3 color = getSceneVec3ByIndex(index + 19);\n\n      float reflection = getSceneDataByIndex(index + 22);\n\n      result.color = vec4(color, 1.0);\n      result.reflection = reflection;\n    }\n\n    bool lightEnabled = (getSceneDataByIndex(index + 24) != 0.0);\n    result.lightEnabled = lightEnabled;\n\n    // if (shadowMode)\n    //     return true;\n  }\n\n  for (int index = u_trianglesStart; index < u_trianglesStop; index += 15)\n  {\n    bool shadowEnabled = (getSceneDataByIndex(index + 13) != 0.0);\n\n    if (shadowMode && !shadowEnabled)\n      continue;\n\n    tmpRay.origin = ray.origin;\n    tmpRay.direction = ray.direction;\n\n    vec3 v0 = getSceneVec3ByIndex(index + 0);\n    vec3 v1 = getSceneVec3ByIndex(index + 3);\n    vec3 v2 = getSceneVec3ByIndex(index + 6);\n\n    float currDistance = 0.0;\n    if (!intersectTriangle(tmpRay, v0, v1, v2, currDistance, normal) || (bestDistance > 0.0 && currDistance > bestDistance))\n      continue;\n\n    bestDistance = currDistance;\n\n    result.hasHit = true;\n    result.depth = bestDistance;\n    result.position = ray.origin + bestDistance * ray.direction;\n    result.normal = normal;\n\n    vec3 color = getSceneVec3ByIndex(index + 9);\n\n    float reflection = getSceneDataByIndex(index + 12);\n\n    result.color = vec4(color, 1.0);\n    result.reflection = reflection;\n\n    bool lightEnabled = (getSceneDataByIndex(index + 14) != 0.0);\n    result.lightEnabled = lightEnabled;\n\n    // if (shadowMode)\n    //     return true;\n  }\n\n  { // plane test\n\n    // vec3 planeNormal = normalize(vec3(0.0, 0.0, 1.0));\n    // float val = intersectPlane(tmpRay, planeNormal, 35.0/4.0*3.0);\n\n    // vec3 planeNormal = normalize(vec3(0.0, 0.0, 1.0));\n    // float val = intersectPlane(tmpRay, planeNormal, 0.0);\n\n    // vec3 planeNormal = normalize(vec3(0.0, 0.0, 1.0));\n    // float val = intersectPlane(tmpRay, planeNormal, 10.0);\n\n    // if (val > 0.0 && (bestDistance <= 0.0 || val < bestDistance))\n    // {\n    //     result.hasHit = true;\n    //     result.depth = val;\n    //     result.position = ray.origin + val * ray.direction;\n    //     result.normal = vec3(planeNormal);\n    //     result.color = vec4(1.0, 1.0, 1.0, 1.0);\n    //     result.reflection = 0.0;\n    //     result.lightEnabled = true;\n    // }\n\n  } // plane test\n\n  return result.hasHit;\n}\n\nfloat lightAt(vec3 impactPosition, vec3 impactNormal, vec3 viewer)\n{\n  float bestIntensity = 0.0;\n\n  for (int index = u_sunLightsStart; index < u_sunLightsStop; index += 4)\n  {\n    if (!g_shadowsEnabled)\n      continue;\n\n    vec3 lightDir = getLightsVec3ByIndex(index + 0);\n    float localIntensity = getLightsDataByIndex(index + 3);\n\n    float coef = localIntensity;\n    lightDir = normalize(lightDir);\n\n    // is the light blocked by an object?\n    RayResult result;\n    if (intersectScene(RayValues(impactPosition, lightDir), result, true))\n      continue; // an object is shadowing this light: ignore this light\n\n    //\n    //\n    //\n\n    float intensity = 0.0;\n    vec3 reflection = reflect(-lightDir, impactNormal);\n    intensity += 0.6 * pow(max(dot(reflection, viewer), 0.0), 30.0);\n    intensity += 1.0 * dot(lightDir, impactNormal);\n\n    intensity *= coef;\n\n    if (bestIntensity < intensity)\n      bestIntensity = intensity;\n  }\n\n  for (int index = u_spotLightsStart; index < u_spotLightsStop; index += 5)\n  {\n    vec3 lightDir = vec3(1.0);\n    float coef = 1.0;\n\n    // spot light\n\n    vec3 lightPos = getLightsVec3ByIndex(index + 0);\n    float lightRadius = getLightsDataByIndex(index + 3);\n\n    vec3 lightToImpactVec3 = lightPos - impactPosition;\n\n    // is too far?\n    float lightToImpactDistance = length(lightToImpactVec3);\n    if (lightToImpactDistance > lightRadius)\n      continue; // too far\n\n    lightDir.x = lightToImpactVec3.x / lightToImpactDistance; // normalize\n    lightDir.y = lightToImpactVec3.y / lightToImpactDistance; // normalize\n    lightDir.z = lightToImpactVec3.z / lightToImpactDistance; // normalize\n\n    float localIntensity = getLightsDataByIndex(index + 4);\n\n    coef = localIntensity * (1.0 - lightToImpactDistance / lightRadius);\n\n    if (!g_shadowsEnabled)\n      continue;\n\n    // is the light blocked by an object?\n    RayResult result;\n    if (intersectScene(RayValues(impactPosition, lightDir), result, true))\n    {\n      // avoid "opposite shadows"\n      if (result.depth < lightToImpactDistance)\n        continue; // shadow\n    }\n\n    //\n    //\n    //\n\n    float intensity = 0.0;\n    vec3 reflection = reflect(-lightDir, impactNormal);\n    intensity += 0.6 * pow(max(dot(reflection, viewer), 0.0), 30.0);\n    intensity += 1.0 * dot(lightDir, impactNormal);\n\n    intensity *= coef;\n\n    if (bestIntensity < intensity)\n      bestIntensity = intensity;\n  }\n\n  return max(g_ambiantLight, bestIntensity);\n}\n\nvoid main()\n{\n  //\n  //\n  // initial ray\n\n  vec3 rayDir = normalize(v_position - u_cameraEye); // camera direction\n  vec3 finalPixelColor = g_backgroundColor;\n\n  RayValues currRay = RayValues(u_cameraEye, rayDir);\n  RayResult result;\n\n  result.position = u_cameraEye;\n  result.reflection = 1.0;\n  result.lightEnabled = true;\n\n  float lastReflection = 1.0;\n\n  const int maxIteration = g_reflectionMax;\n  for (int iterationLeft = maxIteration; iterationLeft >= 0; --iterationLeft)\n  {\n    if (result.reflection <= 0.05)\n      break;\n\n    bool mustStop = false;\n\n    currRay = RayValues(result.position, rayDir);\n\n    result.hasHit = intersectScene(currRay, result, false);\n\n    vec3 tmpColor = g_backgroundColor;\n\n    if (result.hasHit)\n    {\n      float lightIntensity = 1.0;\n\n      if (result.lightEnabled)\n      {\n        lightIntensity = lightAt(result.position, result.normal, -currRay.direction);\n\n        if (lightIntensity <= 0.0)\n        {\n          // not lighted\n          mustStop = true;\n        }\n      }\n\n      tmpColor = result.color.xyz * lightIntensity;\n    }\n\n    finalPixelColor = finalPixelColor * (1.0 - lastReflection) + tmpColor * lastReflection;\n\n    if (mustStop || !result.hasHit)\n    {\n      break;\n    }\n\n    lastReflection *= result.reflection;\n\n    rayDir = reflect(rayDir, result.normal);\n  }\n\n  o_color = vec4(finalPixelColor, 1.0);\n}\n\n'.trim();var oe={};q(oe,{fragment:()=>ai,vertex:()=>ri});var ri="\n\n#version 300 es\n\nprecision highp float;\n\nin vec2 a_vertexPosition;\nin vec2 a_vertexTextureCoord;\n\nout vec2 v_textureCoord;\n\nvoid main(void)\n{\n  v_textureCoord = a_vertexTextureCoord;\n\n  gl_Position = vec4(a_vertexPosition, 1.0, 1.0);\n}\n\n".trim(),ai="\n\n#version 300 es\n\nprecision highp float;\n\nuniform sampler2D u_texture;\nuniform vec2 u_step;\n\nin vec2 v_textureCoord;\n\nout vec4 o_color;\n\nvoid main(void)\n{\n  // gl_FragColor = texture(u_texture, v_textureCoord);\n\n  float total = 0.0;\n  vec4 accumulated = vec4(0.0);\n\n  //\n\n  if (v_textureCoord.x - u_step.x > 0.0)\n  {\n    accumulated += texture(u_texture, vec2(v_textureCoord.x - u_step.x, v_textureCoord.y));\n    total += 1.0;\n  }\n\n  if (v_textureCoord.x + u_step.x > 0.0)\n  {\n    accumulated += texture(u_texture, vec2(v_textureCoord.x + u_step.x, v_textureCoord.y));\n    total += 1.0;\n  }\n\n  if (v_textureCoord.y - u_step.y > 0.0)\n  {\n    accumulated += texture(u_texture, vec2(v_textureCoord.x, v_textureCoord.y - u_step.y));\n    total += 1.0;\n  }\n\n  if (v_textureCoord.y + u_step.y > 0.0)\n  {\n    accumulated += texture(u_texture, vec2(v_textureCoord.x, v_textureCoord.y + u_step.y));\n    total += 1.0;\n  }\n\n  //\n\n  if (v_textureCoord.x - u_step.x > 0.0 && v_textureCoord.y - u_step.y > 0.0)\n  {\n    accumulated += texture(u_texture, vec2(v_textureCoord.x - u_step.x, v_textureCoord.y - u_step.y));\n    total += 1.0;\n  }\n\n  if (v_textureCoord.x + u_step.x > 0.0 && v_textureCoord.y - u_step.y > 0.0)\n  {\n    accumulated += texture(u_texture, vec2(v_textureCoord.x + u_step.x, v_textureCoord.y - u_step.y));\n    total += 1.0;\n  }\n\n  if (v_textureCoord.x - u_step.x > 0.0 && v_textureCoord.y + u_step.y > 0.0)\n  {\n    accumulated += texture(u_texture, vec2(v_textureCoord.x - u_step.x, v_textureCoord.y + u_step.y));\n    total += 1.0;\n  }\n\n  if (v_textureCoord.x + u_step.x > 0.0 && v_textureCoord.y + u_step.y > 0.0)\n  {\n    accumulated += texture(u_texture, vec2(v_textureCoord.x + u_step.x, v_textureCoord.y + u_step.y));\n    total += 1.0;\n  }\n\n  //\n\n  if (total > 0.0)\n    o_color = accumulated / total;\n  else\n    o_color = vec4(1.0, 0.0, 0.0, 1.0); // warning\n}\n\n".trim();var Be=e=>e*Math.PI/180,Te=class{constructor(t){this._resolutionCoef=1;this._antiAliasing=!1;this._spheres=[];this._boxes=[];this._triangles=[];this._sunLights=[];this._spotLights=[];this._cameraFovy=t.fovy,this._renderWidth=this._canvasWidth=t.canvasWidth,this._renderHeight=this._canvasHeight=t.canvasHeight,this._rayTracerShaderProgram=new O("RayTracerRenderer-1",{vertexSrc:se.vertex,fragmentSrc:se.fragment,attributes:["a_vertexPosition","a_plotPosition"],uniforms:["u_cameraEye","u_sceneTextureData","u_sceneTextureSize","u_spheresStart","u_spheresStop","u_boxesStart","u_boxesStop","u_trianglesStart","u_trianglesStop","u_lightsTextureData","u_sunLightsStart","u_sunLightsStop","u_spotLightsStart","u_spotLightsStop"]}),this._textureShaderProgram=new O("RayTracerRenderer-1",{vertexSrc:oe.vertex,fragmentSrc:oe.fragment,attributes:["a_vertexPosition","a_vertexTextureCoord"],uniforms:["u_texture","u_step"]}),this._finalTexture=new W,this._finalTexture.allocate(this._renderWidth,this._renderHeight),this._frameBuffer=new re,this._frameBuffer.attachTexture(this._finalTexture);let r=new P.GeometryBuilder;r.reset().setPrimitiveType("triangleStrip").addVbo().addVboAttribute("a_vertexPosition","vec2f").addVbo().setVboAsDynamic().addVboAttribute("a_plotPosition","vec3f"),this._rayTracerGeometry=new P.Geometry(this._rayTracerShaderProgram,r.getDef());let a=[];a.push(1,1),a.push(-1,1),a.push(1,-1),a.push(-1,-1),this._rayTracerGeometry.updateBuffer(0,a,a.length),this._rayTracerGeometry.setPrimitiveStart(0),this._rayTracerGeometry.setPrimitiveCount(4),r.reset().setPrimitiveType("triangleStrip").addVbo().addVboAttribute("a_vertexPosition","vec2f").addVboAttribute("a_vertexTextureCoord","vec2f"),this._screenGeometry=new P.Geometry(this._textureShaderProgram,r.getDef());let i=[];i.push(1,1,1,1),i.push(-1,1,0,1),i.push(1,-1,1,0),i.push(-1,-1,0,0),this._screenGeometry.updateBuffer(0,i,i.length),this._screenGeometry.setPrimitiveStart(0),this._screenGeometry.setPrimitiveCount(4),this._sceneDataTexture=new te,this._sceneDataTexture.initialize(),this._lightsDataTexture=new te,this._lightsDataTexture.initialize(),this._camera={position:g.fromValues(0,0,0),target:g.fromValues(1.5,1.5,1.5),up:g.fromValues(0,1,0)}}pushSphere(t,r,a,i,n,o=!0,s=!0){if(r<=0)throw new Error("invalid sphere radius");if(i<0||i>1)throw new Error("invalid sphere reflection");this._spheres.push({position:[t[0],t[1],t[2]],radius:r,color:[a[0],a[1],a[2]],reflection:i,chessboard:n,shadowEnabled:o,lightEnabled:s})}pushBox(t,r,a,i,n,o,s,f,l=!0,d=!0){if(n[0]<=0||n[1]<=0||n[2]<=0)throw new Error("invalid box size");if(s<0||s>1)throw new Error("invalid box reflection");let h=k.create();k.identity(h),k.translate(h,h,t),k.rotateY(h,h,a),k.rotateZ(h,h,i),k.rotateX(h,h,r),this._boxes.push({matrix:h,boxSize:g.clone(n),color:g.clone(o),reflection:s,chessboard:f,shadowEnabled:l,lightEnabled:d})}pushTriangle({v0:t,v1:r,v2:a,color:i,reflection:n,shadowEnabled:o,lightEnabled:s}){if(n<0||n>1)throw new Error("invalid triangle reflection");this._triangles.push({v0:g.clone(t),v1:g.clone(r),v2:g.clone(a),color:g.clone(i),reflection:n,shadowEnabled:o,lightEnabled:s})}pushSunLight(t,r){if(r<=0)throw new Error("intensity cannot be 0");if(g.length(t)===0)throw new Error("direction cannot be 0");let a=g.normalize(g.clone(t),t);this._sunLights.push({direction:a,intensity:r})}pushSpotLight(t,r,a){if(r<=0)throw new Error("intensity cannot be 0");if(a<=0)throw new Error("radius cannot be <= 0");this._spotLights.push({position:g.clone(t),intensity:r,radius:a})}lookAt(t,r,a){g.copy(this._camera.position,t);let i=g.sub(g.create(),r,t);i=g.normalize(i,i),i=g.add(i,t,i),g.copy(this._camera.target,i);let n=g.normalize(g.create(),a);g.copy(this._camera.up,n)}render(){let t=T.getContext(),r=this._computeCameraFarCorners();this._rayTracerGeometry.updateBuffer(1,r,r.length);let a=Math.floor(this._renderWidth),i=Math.floor(this._renderHeight);this._frameBuffer.bind(),t.viewport(0,0,a,i),t.clear(t.COLOR_BUFFER_BIT);{let n=this._rayTracerShaderProgram;n.bind(()=>{n.setFloat3Uniform("u_cameraEye",this._camera.position[0],this._camera.position[1],this._camera.position[2]);{let o=[];{{n.setInteger1Uniform("u_spheresStart",0);for(let s of this._spheres)o.push(s.position[0],s.position[1],s.position[2]),o.push(s.radius),o.push(s.color[0],s.color[1],s.color[2]),o.push(s.reflection),o.push(s.shadowEnabled?1:0),o.push(s.lightEnabled?1:0),o.push(s.chessboard?1:0);n.setInteger1Uniform("u_spheresStop",o.length)}{n.setInteger1Uniform("u_boxesStart",o.length);for(let s of this._boxes){for(let f=0;f<16;++f)o.push(s.matrix[f]);o.push(s.boxSize[0],s.boxSize[1],s.boxSize[2]),o.push(s.color[0],s.color[1],s.color[2]),o.push(s.reflection),o.push(s.shadowEnabled?1:0),o.push(s.lightEnabled?1:0),o.push(s.chessboard?1:0)}n.setInteger1Uniform("u_boxesStop",o.length)}{n.setInteger1Uniform("u_trianglesStart",o.length);for(let s of this._triangles)o.push(s.v0[0],s.v0[1],s.v0[2]),o.push(s.v1[0],s.v1[1],s.v1[2]),o.push(s.v2[0],s.v2[1],s.v2[2]),o.push(s.color[0],s.color[1],s.color[2]),o.push(s.reflection),o.push(s.shadowEnabled?1:0),o.push(s.lightEnabled?1:0);n.setInteger1Uniform("u_trianglesStop",o.length)}}t.activeTexture(t.TEXTURE0+0),this._sceneDataTexture.bind(),this._sceneDataTexture.update(o),n.setInteger1Uniform("u_sceneTextureData",0),n.setInteger1Uniform("u_sceneTextureSize",o.length)}{let o=[];{n.setInteger1Uniform("u_sunLightsStart",0);for(let s of this._sunLights)o.push(s.direction[0],s.direction[1],s.direction[2]),o.push(s.intensity);n.setInteger1Uniform("u_sunLightsStop",o.length)}{n.setInteger1Uniform("u_spotLightsStart",o.length);for(let s of this._spotLights)o.push(s.position[0],s.position[1],s.position[2]),o.push(s.radius),o.push(s.intensity);n.setInteger1Uniform("u_spotLightsStop",o.length)}t.activeTexture(t.TEXTURE0+1),this._lightsDataTexture.bind(),this._lightsDataTexture.update(o),n.setInteger1Uniform("u_lightsTextureData",1)}this._rayTracerGeometry.render()})}re.unbind(),t.viewport(0,0,this._canvasWidth,this._canvasHeight),t.clear(t.COLOR_BUFFER_BIT);{let n=this._textureShaderProgram;n.bind(()=>{if(n.setTextureUniform("u_texture",this._finalTexture,0),this._antiAliasing){let o=(1-this._renderWidth/this._canvasWidth)*.005,s=(1-this._renderHeight/this._canvasHeight)*.005;n.setFloat2Uniform("u_step",o,s)}else n.setFloat2Uniform("u_step",0,0);this._screenGeometry.render(),W.unbind()})}}reset(){this._sunLights.length=0,this._spotLights.length=0,this._spheres.length=0,this._boxes.length=0,this._triangles.length=0}setResolutionCoef(t){t===this._resolutionCoef||t<=0||t>1||(this._resolutionCoef=t,this._renderWidth=Math.floor(this._canvasWidth*this._resolutionCoef),this._renderHeight=Math.floor(this._canvasHeight*this._resolutionCoef),this._finalTexture.resize(this._renderWidth,this._renderHeight))}getResolutionCoef(){return this._resolutionCoef}setAntiAliasing(t){this._antiAliasing=t}getAntiAliasing(){return this._antiAliasing}getCurrentSize(){return[this._renderWidth,this._renderHeight]}_computeCameraFarCorners(){let t=g.sub(g.create(),this._camera.target,this._camera.position),r=g.cross(g.create(),t,this._camera.up),a=g.cross(g.create(),r,t),i=Be(this._cameraFovy*.5),n=Math.cos(i)*1/Math.sin(i),o=g.multiply(g.create(),t,g.fromValues(n,n,n)),s=g.add(g.create(),this._camera.position,o),f=this._canvasWidth/this._canvasHeight,l=g.multiply(g.create(),r,g.fromValues(f,f,f)),d=g.add(g.create(),s,a),h=g.subtract(g.create(),s,a),m=g.subtract(g.create(),d,l),u=g.subtract(g.create(),h,l),v=g.add(g.create(),d,l),_=g.add(g.create(),h,l);return[v[0],v[1],v[2],m[0],m[1],m[2],_[0],_[1],_[2],u[0],u[1],u[2]]}get canvasWidth(){return this._canvasWidth}get canvasHeight(){return this._canvasHeight}get renderWidth(){return this._renderWidth}get renderHeight(){return this._renderHeight}get camera(){return this._camera}get spheres(){return this._spheres}get boxes(){return this._boxes}get triangles(){return this._triangles}get sunLights(){return this._sunLights}get spotLights(){return this._spotLights}};var fe={};q(fe,{fragment:()=>ni,vertex:()=>ii});var ii="\n#version 300 es\n\nprecision highp float;\n\nuniform mat4 u_composedMatrix;\n\nin vec2 a_vertex_position;\nin vec2 a_vertex_texCoord;\nin vec3 a_offset_position;\nin vec2 a_offset_texCoord;\nin vec3 a_offset_color;\nin float a_offset_scale;\n\nout vec2 v_texCoord;\nflat out vec3 v_color;\n\nvoid main(void)\n{\n  vec3 position = vec3(a_vertex_position, 0.0) * a_offset_scale + a_offset_position;\n\n  gl_Position = u_composedMatrix * vec4(position, 1.0);\n\n  v_texCoord = a_vertex_texCoord + a_offset_texCoord;\n  v_color = a_offset_color;\n}\n".trim(),ni="\n#version 300 es\n\nprecision mediump float;\n\nuniform sampler2D u_texture;\n\nin vec2 v_texCoord;\nflat in vec3 v_color;\n\nout vec4 o_color;\n\nvoid main(void)\n{\n  vec4 textureColor = texture(u_texture, v_texCoord);\n  if (textureColor.a < 0.5)\n  {\n    discard;\n  }\n  else\n  {\n    o_color = vec4(v_color, textureColor.a);\n  }\n}\n\n".trim();var Ne="7e7e28fd03fd07fe04fe0aff02ff7e4dfd0cfd03fd07fe04fe0aff02ff1afc0dfd10fc08fc0ffe55ff15fb0bfd03fd07fe04fe08f707fd04ff07fe02fe0cfd0ffd0cfd0aff03fe03ff0afe44fe15fb0bfd03fd04f204f607fd03fe07fe02fe0cfd0efd0efd0aff02fe02ff0bfe43fd15fb0cfe03fe05f204fe01ff02ff0afd02fd07fe02fe0bfd0efd10fd0afa0cfe42fd16fb1bfe04fe07fe01ff02ff0efd09fc1cfd12fd09fa0cfe41fd17fb1bfe04fe07f70bfd0afc04ff17fd12fd06f405f616f61cfd19fd1cfe04fe08f709fd0bfb02fe17fd12fd06f405f616f61bfd1afd1cfe04fe0aff02ff01fe08fd0bfe02fa17fd12fd09fa0cfe3efd37f207ff02ff01fe07fd02fd07fe03fc19fd10fd0afa0cfe3dfd38f204f607fe03fd07fe03fd1bfd0efd0aff02fe02ff0bfe0cfd1dfd0dfd1dfd1cfe04fe07f708ff04fd07fe02fb1bfd0cfd0aff03fe03ff0afe0cfd1dfd0cfd1efd1cfe04fe0aff02ff1afb02fe1bfc08fc0ffe1cfd1dfd0bfd1ffd1cfe04fe0aff02ff7afd7e7e7e7e7e7e0efd17fd10fc0af80bfe0bf909f90dfd08f609fb08f506f808f82cfd19fd0df807fd04fd0afe0afd03fd07fd03fd0bfc08fd0ffd0bfd05fd05fd04fd06fd04fd2afd1bfd0bfc02fc06fd03fc09fd0afd04fd06fd04fd09fb08fd0efd0cfd05fd05fd04fd06fd04fd09fd0cfd0efd1dfd0afe05fd06fd02fb06fa11fd0dfd08fe01fd08fd0dfd0dfd05fd05fd04fd06fd04fd09fd0cfd0dfd0af409fd10fd06fd02fb06fa10fd0dfd08fe02fd08fd0dfd15fd05fb02fd06fd04fd09fd0cfd0cfd0bf40afd0efd07fd01fe01fd09fd0ffd0bfb08fe03fd08f808f70efd08fa08f626fd23fd0cfd08fd01fe01fd09fd0efd0cfb08f606f707f60cfd09fa09f726fd23fd0bfd09fb02fd09fd0dfd10fd07f60cfc06fd04fd0bfd08fd02fb0dfd09fd0cfd0cfd0bf40afd0cfd09fb02fd09fd0cfd12fd0bfd0ffd06fd04fd0afd09fd04fd0dfd09fd0cfd0dfd0af409fd19fc03fd09fd0bfd03fd06fd04fd0bfd08fd04fd06fd04fd09fd0afd04fd0cfd0afd0cfd0efd1dfd1afd04fd09fd0afd04fd06fd03fd0cfd08fd03fd07fd04fd09fd0afd04fd0bfd19fd10fd1bfd0ffd0af807f707f607f90bf907f909f80afd0bf809fb2efd19fd10fd7e51fd17fd11fd7e7e7e7e13f87e78fd05fd08fc09f709f907f808f606f608f907fd03fd07f90df905fc03fd06fb0bfd05fd05fd05fd08fb08fd05fd07fa09fd03fd07fd03fd07fd02fd08fd04fe07fd04fe07fd03fd06fd03fd09fd11fd08fd03fd07fd0cfc03fc05fd05fd07fd01fd07fd05fd06fd02fd08fd03fd06fd04fd07fd03fd07fd05ff07fd05ff06fd04fd06fd03fd09fd11fd08fd02fd08fd0cfb01fb05fc04fd06fd03fd06fd05fd05fd04fd07fd03fd06fd0efd03fd07fd0dfd0cfd04fd06fd03fd09fd11fd08fd01fd09fd0cf505fb03fd05fd05fd05fd02fa05fd04fd07fd03fd06fd0efd03fd07fd03fe08fd03fe07fd0dfd03fd09fd11fd08fa0afd0cf505fa02fd05fd05fd05fd02fa05fd04fd07f807fd0efd03fd07f808f807fd0df709fd11fd08fb0bfd0cfd01fd01fd05fd01fd01fd05fd05fd05fd02fa05fd04fd07f807fd0efd03fd07f808f807fd0df709fd11fd08fb0bfd0cfd02ff02fd05fd02fa05fd05fd05fd02fa05f607fd03fd06fd0efd03fd07fd03fe08fd03fe07fd02fb06fd03fd09fd0bfd03fd08fa0afd0cfd05fd05fd03fb05fd05fd05fd0dfd04fd07fd03fd06fd0efd03fd07fd0dfd0cfd04fd06fd03fd09fd0bfd03fd08fd01fd09fd05ff06fd05fd05fd04fc05fd05fd05fd0dfd04fd07fd03fd06fd04fd07fd03fd07fd05ff07fd0cfd04fd06fd03fd09fd0bfd03fd08fd02fd08fd04fe06fd05fd05fd05fd06fd03fd06fd0dfd04fd07fd03fd07fd03fd07fd02fd08fd04fe07fd0dfd03fd06fd03fd09fd0bfd03fd08fd03fd07fd03fd06fd05fd05fd05fd07fd01fd07fd0dfd04fd06f709f907f808f606fb0df806fd03fd07f90af908fc03fd06f606fd05fd05fd05fd08fb0af87e7e7e7e7e7e7e68fe1af70afb08f708f807f505fd03fd07fd03fd07fd05fd05fd03fd07fd03fd07f608f907ff11f90afc1afd03fd07fc01fc07fd03fd06fd04fd06fe02fd02fe05fd03fd07fd03fd07fd05fd05fd03fd07fd03fd07fd04fd08fd0bfe14fd09fa19fd03fd07fd03fd07fd03fd06fd04fd06ff03fd03ff05fd03fd07fd03fd07fd05fd05fd03fd07fd03fd07fe05fd08fd0bfd13fd08fd02fd18fd03fd06fd05fd06fd03fd06fd04fd0afd09fd03fd07fd03fd07fd05fd06fd01fd08fd03fd07ff05fd09fd0cfd12fd07fd04fd17fd03fd06fd05fd06fd03fd06fd11fd09fd03fd07fd03fd07fd05fd07fb09fd03fd0cfd0afd0dfd11fd28f807fd05fd06f808f90cfd09fd03fd07fd03fd07fd02ff02fd08fd0bfd01fd0cfd0bfd0efd10fd28f807fd05fd06f809f90bfd09fd03fd07fd03fd07fd02ff02fd08fd0cfb0cfd0cfd0ffd0ffd28fd0cfd03fb06fd02fd0efd0afd09fd03fd07fd03fd07fd02ff02fd07fb0cfd0cfd0dfd10fd0efd28fd0cfd02fa06fd03fd06fd04fd0afd09fd03fd07fd03fd08f707fd01fd0bfd0bfd05ff08fd11fd0dfd28fd0df707fd03fd06fd04fd0afd09fd03fd08fd01fd09fc01fc06fd03fd0afd0afd05fe08fd12fd0cfd28fd0df707fd03fd06fd04fd0afd09fd03fd09fb0bfd01fd07fd03fd0afd0afd04fd08fd13fd0bfd27fb12fd06fc03fd07f809f908f90bfd0cfd01fd07fd03fd08f908f608f910fd06f93cfa7e54f07e72f07e7e7e7e0bfd1dfc21fb19fb18fc10fd0ffd07fc0dfa39fd1efd22fd19fd01fd18fd10fd0ffd08fd10fd3bfd1cfd22fd19fd01fd18fd10fd0ffd08fd10fd3bfd1cfd22fd19fd1cfd2dfd10fd4af909f808f909f808f90afd0cfb02fe07fd01fc08fa0cfa08fd03fd0afd09f606f809f91efd08fd03fd06fd03fd07fd03fd07fd03fd07f808fd03fd08fc02fd0afd0ffd08fd02fd0bfd09fd02ff02fd05fd03fd07fd03fd1dfd08fd03fd06fd03fd07fd03fd07fd03fd07f808fd03fd08fc02fd0afd0ffd08fd01fd0cfd09fd02ff02fd05fd03fd07fd03fd18f808fd03fd06fd0dfd03fd07f709fd0bfd03fd08fd03fd0afd0ffd08fa0dfd09fd02ff02fd05fd03fd07fd03fd17fd03fd08fd03fd06fd0dfd03fd07fd0ffd0bfd03fd08fd03fd0afd0ffd08fd01fd0cfd09fd02ff02fd05fd03fd07fd03fd17fd03fd08fd03fd06fd03fd07fd03fd07fd03fd09fd0cf808fd03fd0afd0ffd08fd02fd0bfd09fd02ff02fd05fd03fd07fd03fd17fd03fd08fd03fd06fd03fd07fd03fd07fd03fd09fd0df908fd03fd0afd0ffd08fd03fd0afd09fd02ff02fd05fd03fd07fd03fd18fb02fe06fe02fb08f909fb02fe07f908f90ffd07fc03fd07f706fd03fd07fc03fd07f706fd05fd05fd03fd08f978fd03fd27fd03fd7e4af92afa7e7e7e7e7e7e18fa09fc09fa1efe4eff6efd0dfc0dfd1cfc4cfe6efd0dfc0dfd1bfa4afd6efd0dfc0dfd1afd02fd07fe02fb07fb02fe07fc02fd08f908f707fd03fd07fd03fd07fd05fd05fd02fd09fd03fd06f80afd0efc0efd08fb03fd05fd04fd07fd03fd05fd03fd09f706fd04fe09fd0bfd03fd07fd03fd07fd05fd05fd02fd09fd03fd06fe03fd08fd24fd05fd01fd02fd05fe06fe07fd03fd05fd03fd09fc02fd06fd04fe09fd0bfd03fd07fd03fd07fd05fd06fa0afd03fd06ff03fd09fd24fd05fd02fd01fd05fe06fe07fd03fd05fd03fd09fd0dfb0cfd0bfd03fd07fd03fd07fd02ff02fd07fc0bfd03fd09fd0cfd0efc0efd07fd03fb06fe06fe07fd03fd05fd03fd09fd0ffb0afd0bfd03fd07fd03fd07fd02ff02fd07fc0bfd03fd08fd0efd0dfc0dfd19fe06fe07fd03fd05fd03fd09fd0cfe04fd09fd01fd07fd03fd08fd01fd09fc01fc07fa0bf908fd03ff0bfd0dfc0dfd19fe06fe07f807f809fd0cfe04fd09fd01fd07fd03fd09fb0bfd01fd07fd02fd0bfb08fd03fe0bfd0dfc0dfd19f607fd11fd08fb0cf90bfb09fb02fe09fd0cfd01fd07fd02fd0dfd08f80cfa09fc09fa1af607fd11fd7cfd69fb0ffb77fa";var Rt=[16,6],c=[1/Rt[0],1/Rt[1]],St=9*1024*4,Me=class{constructor(){this._texture=new W;this._buffer=new Float32Array(St);this._currentSize=0;this._textScale=14;this._textColor=[1,1,1];this._horizontalTextAlign="left";this._verticalTextAlign="top";this._shader=new O("TextRenderer",{vertexSrc:fe.vertex,fragmentSrc:fe.fragment,attributes:["a_vertex_position","a_vertex_texCoord","a_offset_position","a_offset_texCoord","a_offset_color","a_offset_scale"],uniforms:["u_composedMatrix","u_texture"]});let t=new P.GeometryBuilder;t.reset().setPrimitiveType("triangles").addVbo().addVboAttribute("a_vertex_position","vec2f").addVboAttribute("a_vertex_texCoord","vec2f").setStride(4*4).addVbo().setVboAsDynamic().setVboAsInstanced().addVboAttribute("a_offset_position","vec3f").addVboAttribute("a_offset_texCoord","vec2f").addVboAttribute("a_offset_color","vec3f").addVboAttribute("a_offset_scale","float").setStride(9*4),this._geometry=new P.Geometry(this._shader,t.getDef());let r=[{position:[.5,-.5],texCoord:[c[0]*1,c[1]*1]},{position:[-.5,-.5],texCoord:[c[0]*0,c[1]*1]},{position:[.5,.5],texCoord:[c[0]*1,c[1]*0]},{position:[-.5,.5],texCoord:[c[0]*0,c[1]*0]}],a=[1,0,2,1,2,3],i=[];for(let f of a){let l=r[f];i.push(l.position[0],l.position[1],l.texCoord[0],l.texCoord[1])}this._geometry.updateBuffer(0,i,i.length),this._geometry.setPrimitiveCount(i.length/4),this._geometry.setFloatBufferSize(1,St),this._texCoordMap=new Map([[" ",[0*c[0],0*c[1]]],["!",[1*c[0],0*c[1]]],['"',[2*c[0],0*c[1]]],["#",[3*c[0],0*c[1]]],["$",[4*c[0],0*c[1]]],["%",[5*c[0],0*c[1]]],["&",[6*c[0],0*c[1]]],["'",[7*c[0],0*c[1]]],["(",[8*c[0],0*c[1]]],[")",[9*c[0],0*c[1]]],["*",[10*c[0],0*c[1]]],["+",[11*c[0],0*c[1]]],[",",[12*c[0],0*c[1]]],["-",[13*c[0],0*c[1]]],[".",[14*c[0],0*c[1]]],["/",[15*c[0],0*c[1]]],["0",[0*c[0],1*c[1]]],["1",[1*c[0],1*c[1]]],["2",[2*c[0],1*c[1]]],["3",[3*c[0],1*c[1]]],["4",[4*c[0],1*c[1]]],["5",[5*c[0],1*c[1]]],["6",[6*c[0],1*c[1]]],["7",[7*c[0],1*c[1]]],["8",[8*c[0],1*c[1]]],["9",[9*c[0],1*c[1]]],[":",[10*c[0],1*c[1]]],[";",[11*c[0],1*c[1]]],["<",[12*c[0],1*c[1]]],["=",[13*c[0],1*c[1]]],[">",[14*c[0],1*c[1]]],["?",[15*c[0],1*c[1]]],["@",[0*c[0],2*c[1]]],["A",[1*c[0],2*c[1]]],["B",[2*c[0],2*c[1]]],["C",[3*c[0],2*c[1]]],["D",[4*c[0],2*c[1]]],["E",[5*c[0],2*c[1]]],["F",[6*c[0],2*c[1]]],["G",[7*c[0],2*c[1]]],["H",[8*c[0],2*c[1]]],["I",[9*c[0],2*c[1]]],["J",[10*c[0],2*c[1]]],["K",[11*c[0],2*c[1]]],["L",[12*c[0],2*c[1]]],["M",[13*c[0],2*c[1]]],["N",[14*c[0],2*c[1]]],["O",[15*c[0],2*c[1]]],["P",[0*c[0],3*c[1]]],["Q",[1*c[0],3*c[1]]],["R",[2*c[0],3*c[1]]],["S",[3*c[0],3*c[1]]],["T",[4*c[0],3*c[1]]],["U",[5*c[0],3*c[1]]],["V",[6*c[0],3*c[1]]],["W",[7*c[0],3*c[1]]],["X",[8*c[0],3*c[1]]],["Y",[9*c[0],3*c[1]]],["Z",[10*c[0],3*c[1]]],["[",[11*c[0],3*c[1]]],["\\",[12*c[0],3*c[1]]],["]",[13*c[0],3*c[1]]],["^",[14*c[0],3*c[1]]],["_",[15*c[0],3*c[1]]],["`",[0*c[0],4*c[1]]],["a",[1*c[0],4*c[1]]],["b",[2*c[0],4*c[1]]],["c",[3*c[0],4*c[1]]],["d",[4*c[0],4*c[1]]],["e",[5*c[0],4*c[1]]],["f",[6*c[0],4*c[1]]],["g",[7*c[0],4*c[1]]],["h",[8*c[0],4*c[1]]],["i",[9*c[0],4*c[1]]],["j",[10*c[0],4*c[1]]],["k",[11*c[0],4*c[1]]],["l",[12*c[0],4*c[1]]],["m",[13*c[0],4*c[1]]],["n",[14*c[0],4*c[1]]],["o",[15*c[0],4*c[1]]],["p",[0*c[0],5*c[1]]],["q",[1*c[0],5*c[1]]],["r",[2*c[0],5*c[1]]],["s",[3*c[0],5*c[1]]],["t",[4*c[0],5*c[1]]],["u",[5*c[0],5*c[1]]],["v",[6*c[0],5*c[1]]],["w",[7*c[0],5*c[1]]],["x",[8*c[0],5*c[1]]],["y",[9*c[0],5*c[1]]],["z",[10*c[0],5*c[1]]],["{",[11*c[0],5*c[1]]],["|",[12*c[0],5*c[1]]],["}",[13*c[0],5*c[1]]],["~",[14*c[0],5*c[1]]]]);let n=256,o=96,s=new Uint8Array(n*o*4);{let f=0;for(let l=0;l<Ne.length;l+=2){let d=parseInt("".concat(Ne.substring(l,l+2),"000000"),16)>>24,h=0;d<0&&(d=-d,h=255);for(let m=0;m<d;++m)s[f*4+0]=h,s[f*4+1]=h,s[f*4+2]=h,s[f*4+3]=h,++f}}this._texture.loadFromMemory(n,o,s)}setTextAlign(t,r){return this._horizontalTextAlign=t,this._verticalTextAlign=r,this}setTextScale(t){return this._textScale=t,this}setTextColor(t,r,a){return this._textColor[0]=t,this._textColor[1]=r,this._textColor[2]=a,this}pushText(t,r){if(t.length===0)return this;if(this._textScale<=0)return this;let a=[0];for(let s=0;s<t.length;++s)t[s]=="\n"?a.push(0):a[a.length-1]+=1;if(a.length===0)return this;let i=0,n=[0,0],o=this._textScale*.5;switch(this._horizontalTextAlign){case"left":n[0]=r[0];break;case"centered":n[0]=r[0]-a[i]*o+o;break;case"right":n[0]=r[0]-a[i]*this._textScale+this._textScale;break}switch(this._verticalTextAlign){case"top":n[1]=r[1];break;case"centered":n[1]=r[1]+a.length*o-o;break;case"bottom":n[1]=r[1]-(a.length-1)*this._textScale;break}for(let s=0;s<t.length;++s){let f=t[s];if(f=="\n"){switch(i+=1,this._horizontalTextAlign){case"left":n[0]=r[0];break;case"centered":n[0]=r[0]-a[i]*o+o;break;case"right":n[0]=r[0]-a[i]*this._textScale+this._textScale;break}n[1]-=this._textScale}else this._pushLetter(f,n),n[0]+=this._textScale}return this}_pushLetter(t,r){if(this._currentSize+9*10>=this._buffer.length)return;let a=this._texCoordMap.get(t);if(!a)throw new Error("fail to find a letter, letter=".concat(t));for(let i=-1;i<=1;++i)for(let n=-1;n<=1;++n)this._buffer[this._currentSize++]=r[0]+2*n,this._buffer[this._currentSize++]=r[1]+2*i,this._buffer[this._currentSize++]=-.1,this._buffer[this._currentSize++]=a[0],this._buffer[this._currentSize++]=a[1],this._buffer[this._currentSize++]=0,this._buffer[this._currentSize++]=0,this._buffer[this._currentSize++]=0,this._buffer[this._currentSize++]=this._textScale;this._buffer[this._currentSize++]=r[0],this._buffer[this._currentSize++]=r[1],this._buffer[this._currentSize++]=0,this._buffer[this._currentSize++]=a[0],this._buffer[this._currentSize++]=a[1],this._buffer[this._currentSize++]=this._textColor[0],this._buffer[this._currentSize++]=this._textColor[1],this._buffer[this._currentSize++]=this._textColor[2],this._buffer[this._currentSize++]=this._textScale}flush(t){return this._currentSize===0?this:(this._shader.bind(()=>{this._shader.setMatrix4Uniform("u_composedMatrix",t),this._shader.setTextureUniform("u_texture",this._texture,0),this._geometry.updateBuffer(1,this._buffer,this._currentSize),this._geometry.setInstancedCount(this._currentSize/9),this._geometry.render()}),W.unbind(),this.clear(),this)}clear(){return this._currentSize=0,this}};var Tt=70,Ee=class{constructor(t){this._debugSceneCamera=new me;this._mainHudCamera=new me;this._def=t,this.resize(this._def.canvasDomElement.width,this._def.canvasDomElement.height),T.initialize(this._def.canvasDomElement),this._rayTracerRenderer=new Te({canvasWidth:this._def.canvasDomElement.width,canvasHeight:this._def.canvasDomElement.height,fovy:Tt}),this._textRenderer=new Me,this._stackRenderers=new Se}initialize(){let t=T.getContext(),r=1;t.pixelStorei(t.UNPACK_ALIGNMENT,r),t.disable(t.DEPTH_TEST),t.disable(t.BLEND),t.disable(t.CULL_FACE),t.depthFunc(t.NEVER),t.clearColor(0,0,0,1),t.clearDepth(1)}resize(t,r){this._debugSceneCamera.setViewportSize(t,r),this._debugSceneCamera.setAsPerspective({fovy:Be(Tt),near:1,far:500}),this._mainHudCamera.setViewportSize(t,r);let a=t*.5,i=r*.5;this._mainHudCamera.setAsOrthogonal({left:-a,right:+a,top:-i,bottom:+i,near:-200,far:200}),this._mainHudCamera.setEye([a,i,1]),this._mainHudCamera.setTarget([a,i,0]),this._mainHudCamera.setUpAxis([0,1,0]),this._mainHudCamera.computeMatrices()}_pushWireFrameSphere(t){let r=.5257311121191336*t.radius,a=.8506508083520399*t.radius,i=0,n=[[-r,i,a],[r,i,a],[-r,i,-a],[r,i,-a],[i,a,r],[i,a,-r],[i,-a,r],[i,-a,-r],[a,r,i],[-a,r,i],[a,-r,i],[-a,-r,i]];for(let s=0;s<n.length;++s)n[s][0]+=t.position[0],n[s][1]+=t.position[1],n[s][2]+=t.position[2];let o=[[0,4,1],[0,9,4],[9,5,4],[4,5,8],[4,8,1],[8,10,1],[8,3,10],[5,3,8],[5,2,3],[2,7,3],[7,10,3],[7,6,10],[7,11,6],[11,0,6],[0,1,6],[6,1,10],[9,0,11],[9,11,2],[9,2,5],[7,2,11]];for(let s of o){let f=n[s[0]],l=n[s[1]],d=n[s[2]];this._stackRenderers.pushLine(f,l,t.color),this._stackRenderers.pushLine(l,d,t.color),this._stackRenderers.pushLine(d,f,t.color)}}_pushWireFrameBox(t){let r=[g.fromValues(-t.boxSize[0],-t.boxSize[1],-t.boxSize[2]),g.fromValues(+t.boxSize[0],-t.boxSize[1],-t.boxSize[2]),g.fromValues(-t.boxSize[0],+t.boxSize[1],-t.boxSize[2]),g.fromValues(+t.boxSize[0],+t.boxSize[1],-t.boxSize[2]),g.fromValues(-t.boxSize[0],-t.boxSize[1],+t.boxSize[2]),g.fromValues(+t.boxSize[0],-t.boxSize[1],+t.boxSize[2]),g.fromValues(-t.boxSize[0],+t.boxSize[1],+t.boxSize[2]),g.fromValues(+t.boxSize[0],+t.boxSize[1],+t.boxSize[2])],a=[];r.forEach(n=>{let o=g.fromValues(0,0,0);g.transformMat4(o,n,t.matrix),a.push(o)}),[[0,1],[1,3],[3,2],[2,0],[4,5],[5,7],[7,6],[6,4],[0,4],[1,5],[3,7],[2,6]].forEach(n=>{this._stackRenderers.pushLine(a[n[0]],a[n[1]],t.color)})}_pushWireFrameTriangle(t){this._stackRenderers.pushLine(t.v0,t.v1,t.color),this._stackRenderers.pushLine(t.v1,t.v2,t.color),this._stackRenderers.pushLine(t.v2,t.v0,t.color)}safeSceneWireFrame(t){this._debugSceneCamera.setEye(this._rayTracerRenderer.camera.position),this._debugSceneCamera.setTarget(this._rayTracerRenderer.camera.target),this._debugSceneCamera.setUpAxis(this._rayTracerRenderer.camera.up),this._debugSceneCamera.computeMatrices(),this._stackRenderers.safeRender(this._debugSceneCamera.getComposedMatrix(),t)}flushHudWireFrame(){this._stackRenderers.flush(this._mainHudCamera.getComposedMatrix())}flushHudText(){this._textRenderer.flush(this._mainHudCamera.getComposedMatrix())}setupDebugRenderer(){this._rayTracerRenderer.spheres.forEach(t=>this._pushWireFrameSphere(t)),this._rayTracerRenderer.boxes.forEach(t=>this._pushWireFrameBox(t)),this._rayTracerRenderer.triangles.forEach(t=>this._pushWireFrameTriangle(t))}get rayTracerRenderer(){return this._rayTracerRenderer}get stackRenderers(){return this._stackRenderers}get textRenderer(){return this._textRenderer}};var Y=[],Z=0,X=[],ue=0,H=6,we=10,pe=[];for(let e=0;e<H;++e)for(let t=0;t<H;++t)pe.push([[t*we-H*.5*we,-4+Math.random()*3,e*we-H*.5*we],[Math.random(),Math.random(),Math.random()]]);var Mt=(e,t,r,a,i,n)=>{{for(let l=1;l<H;++l)for(let d=1;d<H;++d){let h=pe[(l-1)*H+(d-1)],m=pe[(l-0)*H+(d-1)],u=pe[(l-1)*H+(d-0)],v=pe[(l-0)*H+(d-0)],_=h[1],p=v[1];e.rayTracerRenderer.pushTriangle({v0:m[0],v1:h[0],v2:u[0],color:_,reflection:.1,shadowEnabled:!0,lightEnabled:!0}),e.rayTracerRenderer.pushTriangle({v0:v[0],v1:m[0],v2:u[0],color:p,reflection:.1,shadowEnabled:!0,lightEnabled:!0})}e.rayTracerRenderer.pushTriangle({v0:[5,5,1],v1:[10,10,1],v2:[10,5,1],color:[1,1,1],reflection:.1,shadowEnabled:!0,lightEnabled:!0}),e.rayTracerRenderer.pushBox([-10,0,-10],0,0,0,[1,5,1],[1,1,1],0,!1),e.rayTracerRenderer.pushBox([10,0,-10],0,0,0,[1,5,1],[1,1,1],0,!1),e.rayTracerRenderer.pushBox([-10,0,10],0,0,0,[1,5,1],[1,1,1],0,!1),e.rayTracerRenderer.pushBox([10,0,10],0,0,0,[1,5,1],[1,1,1],0,!1),e.rayTracerRenderer.pushBox([5,0,10],0,0,0,[2,.5,1],[1,0,0],0,!1),e.rayTracerRenderer.pushBox([5+1,0+.5,10+0],0,0,0,[.75,.25,.5],[.5,.5,.5],0,!1),e.rayTracerRenderer.pushBox([5-1,0-.25,10+1.5],0,0,0,[1,.25,.5],[1,1,0],0,!1),e.rayTracerRenderer.pushBox([5-1,0-.25,10-1.5],0,0,0,[1,.25,.5],[1,1,0],0,!1),e.rayTracerRenderer.pushBox([5-1,0+1,10+0],0,0,0,[1,.5,.25],[1,1,0],0,!1),e.rayTracerRenderer.pushSphere([15,0,15],1,[1,1,1],.5,!1),e.rayTracerRenderer.pushSphere([5,0,5],1,[1,1,1],.5,!1);let o=(a/100*2-1)*Math.PI*2,s=(i/100*2-1)*Math.PI*2,f=(n/100*2-1)*Math.PI*2;e.rayTracerRenderer.pushBox([0,0,0],o,s,f,[2,1,.5],[1,.5,.5],.8,!0),e.rayTracerRenderer.pushBox([0,2.5,0],o,s,f,[2,1,.5],[1,.5,.5],.8,!0);for(let l=0;l<8;++l){let d=l/8;e.rayTracerRenderer.pushSphere([Math.sin(r*.5+Math.PI*2*d)*8,Math.sin(r*.5+Math.PI*2*d)*1+1,Math.cos(r*.5+Math.PI*2*d)*8],.5,[d,1-d,0],0,!1)}e.rayTracerRenderer.pushSunLight([1,1,1],1);{let l=r*-.5,d=[Math.sin(l)*7,4,Math.cos(l)*7],h=[Math.sin(l+Math.PI*.5)*7,4,Math.cos(l+Math.PI*.5)*7];e.rayTracerRenderer.pushSphere(d,.5,[1,1,1],0,!1,!1,!1),e.rayTracerRenderer.pushSphere(h,.5,[1,1,1],0,!1,!1,!1),e.rayTracerRenderer.pushSpotLight(d,5,10),e.rayTracerRenderer.pushSpotLight(h,5,10)}{if(Z>0&&(Z-=t),Z<=0)Z=3,Y.push({pos:[-8,0,-5],vel:[0,0,0],life:.35,maxLife:.35}),ue=0;else if(Z>1&&Z<3&&(ue>0&&(ue-=t),ue<=0)){ue=1/16;let l=(h,m)=>Math.random()*(m-h)+h,d=Z>2&&Z<3?5:1;for(let h=0;h<d;++h){let m=[2*l(-1,1),4+2*l(-1,1),2*l(-1,1)];X.push({pos:[-8,1,-5],vel:m,life:1,maxLife:1})}}for(let l=0;l<Y.length;){if(Y[l].life-=t,Y[l].life<=0){Y.splice(l,1);continue}let d=Y[l].life/Y[l].maxLife,h=Math.sin(d*Math.PI),m=h*2;if(m>0){let u=h*2,v=h*2;e.rayTracerRenderer.pushSphere(Y[l].pos,m,[1,1,1],0,!1,!1,!1),e.rayTracerRenderer.pushSpotLight(Y[l].pos,u*5,v*5)}++l}{let l=g.fromValues(1,.5,0),d=g.fromValues(.2,.2,.2),h=g.fromValues(0,0,0);for(let m=0;m<X.length;){if(X[m].life-=t,X[m].life<=0){X.splice(m,1);continue}let{pos:u,vel:v}=X[m];g.scaleAndAdd(u,u,v,t);let _=X[m].life/X[m].maxLife,p=Math.sin(_*Math.PI);p>0&&(h=g.lerp(h,d,l,_),e.rayTracerRenderer.pushSphere(X[m].pos,p,h,0,!1,!0)),++m}}}}};var De=60,Ve=class{constructor(t){this._currFrameTime=Date.now();this._frameProfiler=new xe;this._continuousTime=0;this._perfAutoScalingEnabled=!0;this._framesUntilNextCheck=De;this._canvasElement=t.canvasElement,this._def=t,this._freeFlyController=new ye({coordinates:["Z","X","Y"],position:[-10,9,22],theta:Math.PI*.85,phi:-Math.PI*.15,mouseSensibility:.1,keyboardSensibility:Math.PI*.45,touchSensibility:.3,movingSpeed:10}),z.activate(),J.activate(this._canvasElement),j.allowPointerLockedOnClickEvent(this._canvasElement),j.addOnLockChange(()=>{j.isPointerLocked(this._canvasElement)?(this._def.logger.log("The pointer lock status is now locked"),Q.activate()):(this._def.logger.log("The pointer lock status is now unlocked"),Q.deactivate(),j.allowPointerLockedOnClickEvent(this._canvasElement))}),j.addOnLockError(r=>{this._def.logger.log('The pointer lock sent an error, event: "'.concat(JSON.stringify(r),'"'))}),this._renderer=new Ee({canvasDomElement:this._canvasElement}),this._renderer.initialize(),this._running=!1,this._errorGraphicContext=!1,this._def.resolution.addEventListener("input",r=>{let a=this._def.resolution.value;this._setResolution(11-a)}),this._def.anti_aliasing_enabled.addEventListener("click",()=>{let r=this._def.anti_aliasing_enabled.checked===!0;this._renderer.rayTracerRenderer.setAntiAliasing(r),this._def.logger.log("Anti aliasing change: ".concat(r===!0?"enabled":"disabled"))});{let r=this._def.resolution.value;this._setResolution(11-r)}this._def.logger.log("user interface initialized"),this._def.perfAutoScaling.addEventListener("input",()=>{this._framesUntilNextCheck=De,this._perfAutoScalingEnabled=this._def.perfAutoScaling.checked===!0,this._def.logger.log("Performance auto scaler change: ".concat(this._perfAutoScalingEnabled===!0?"enabled":"disabled"))})}async init(){await this._renderer.initialize()}resize(t,r,a){let i=t,n=r;a?(this._canvasElement.style.position="absolute",i=window.innerWidth,n=window.innerHeight):this._canvasElement.style.position="relative",this._canvasElement.style.left="0px",this._canvasElement.style.top="0px",this._canvasElement.style.width="".concat(i,"px"),this._canvasElement.style.height="".concat(n,"px"),this._canvasElement.width=i,this._canvasElement.height=n,this._renderer.resize(i,n)}start(){this.isRunning()||(this._running=!0,this._tick())}stop(){this._running=!1}isRunning(){return this._running&&!this._errorGraphicContext}_tick(){let t=()=>{!this._running||this._errorGraphicContext||(window.requestAnimationFrame(t),this._mainLoop())};t()}_mainLoop(){let t=Date.now(),r=t-this._currFrameTime;this._currFrameTime=t,this._frameProfiler.pushDelta(r),this._handlePerformanceAutoScaling(r);let a=r/1e3;this._continuousTime+=a,this._freeFlyController.update(a),Q.resetDelta();{let o=T.getContext();o.disable(o.DEPTH_TEST)}this._continuousTime+=a,Mt(this._renderer,a,this._continuousTime,this._def.angle_x.value,this._def.angle_y.value,this._def.angle_z.value),this._renderer.rayTracerRenderer.lookAt(this._freeFlyController.getPosition(),this._freeFlyController.getTarget(),this._freeFlyController.getUpAxis()),this._renderer.rayTracerRenderer.render(),this._def.debug_mode_enabled.checked===!0&&this._renderer.safeSceneWireFrame(()=>{this._renderer.setupDebugRenderer(),this._renderer.stackRenderers.pushLine([0,0,0],[100,0,0],[1,0,0]),this._renderer.stackRenderers.pushLine([0,0,0],[0,100,0],[0,1,0]),this._renderer.stackRenderers.pushLine([0,0,0],[0,0,100],[0,0,1])});let n=T.getContext();n.clear(n.DEPTH_BUFFER_BIT),n.enable(n.DEPTH_TEST),n.depthFunc(n.LESS),xt(this._canvasElement,this._renderer.stackRenderers,this._renderer.textRenderer),je([10,this._canvasElement.height-60,0],[100,50],this._frameProfiler,this._renderer.stackRenderers,this._renderer.textRenderer,!0),this._renderer.flushHudWireFrame(),this._renderer.flushHudText(),this._renderer.rayTracerRenderer.reset()}_setResolution(t){this._renderer.rayTracerRenderer.setResolutionCoef(1/t);let r=this._renderer.rayTracerRenderer.getCurrentSize(),a=r[0]*r[1];this._def.logger.log("resolution changed (1/".concat(t,") => ").concat(r[0],"x").concat(r[1]," (").concat(a,"px)"))}_handlePerformanceAutoScaling(t){if(this._perfAutoScalingEnabled!==!0)return;if(t<=20){this._framesUntilNextCheck=De;return}if(--this._framesUntilNextCheck,this._framesUntilNextCheck>0)return;this._def.logger.log("performance auto scaling: slow framerate, scaling down resolution");let a=parseInt(this._def.resolution.value,10)-1;a>=1&&a<=10&&(this._setResolution(11-a),this._def.resolution.value="".concat(a)),this._framesUntilNextCheck=De}};var oi=async()=>{let e,t=null,r=async m=>{e?e.error(m.message):console.error(m.message),t&&t.stop()};window.addEventListener("error",r),e=new _e("loggerOutput"),e.log("page loaded");let a=m=>{let u=document.querySelector(m);if(!u)throw new Error('html element "'.concat(m,'" not found'));return u},i=a("#rendering-canvas"),n=a("#auto-scaling-enabled"),o=a("#resolution"),s=a("#anti-aliasing-enabled"),f=a("#debug-mode-enabled"),l=a("#angle-x"),d=a("#angle-y"),h=a("#angle-z");if(!qe())throw new Error("missing WebGL2 feature (unsupported)");t=new Ve({canvasElement:i,logger:e,perfAutoScaling:n,resolution:o,anti_aliasing_enabled:s,debug_mode_enabled:f,angle_x:l,angle_y:d,angle_z:h}),e.log("initializing"),await t.init(),e.log("initialized"),t.start(),e.log("running")};window.addEventListener("load",oi,!1);})();
